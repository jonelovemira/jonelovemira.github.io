<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>标题</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="描述">
<meta property="og:type" content="website">
<meta property="og:title" content="标题">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="标题">
<meta property="og:description" content="描述">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="标题">
<meta name="twitter:description" content="描述">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="http://www.weixinqz.com/uploadfile/2014/1211/20141211051701675.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Jone Xu</a></h1>
		</hgroup>

		
		<p class="header-subtitle">副标题</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
						
						<li>Links</li>
						
						
						<li>Über</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="#" title="github">github</a>
					        
								<a class="mail" target="_blank" href="#" title="mail">mail</a>
					        
								<a class="facebook" target="_blank" href="#" title="facebook">facebook</a>
					        
								<a class="twitter" target="_blank" href="#" title="twitter">twitter</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/ipc-web/" style="font-size: 10px;">ipc-web</a> <a href="/tags/front-end/" style="font-size: 10px;">前端</a> <a href="/tags/refactor/" style="font-size: 10px;">重构</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">奥巴马的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">卡卡的美丽传说</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">本泽马的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">吉格斯的博客</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">习大大大不同</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://localhost:4000/">托蒂的博客</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">我是谁，我从哪里来，我到哪里去？我就是我，是颜色不一样的吃货…</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">Jone Xu</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="http://www.weixinqz.com/uploadfile/2014/1211/20141211051701675.jpg" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">Jone Xu</h1>
			</hgroup>
			
			<p class="header-subtitle">副标题</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="#" title="github">github</a>
			        
						<a class="mail" target="_blank" href="#" title="mail">mail</a>
			        
						<a class="facebook" target="_blank" href="#" title="facebook">facebook</a>
			        
						<a class="twitter" target="_blank" href="#" title="twitter">twitter</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
  
    <article id="post-ipc-web重构 (八) 重构后" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/25/ipc-web重构 (八) 重构后/" class="article-date">
  	<time datetime="2016-04-25T02:37:52.000Z" itemprop="datePublished">2016-04-25</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/25/ipc-web重构 (八) 重构后/">ipc-web重构 (八) 重构后</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><br>前端代码重构至今，除了一些需要与后台联调的接口之外，已经覆盖了所有的现有云平台的所有业务代码。但是大部分代码均处于自测阶段，并未经过测试部的测试流程。不过幸亏的是，主要核心的业务已经经过测试部分几轮提测并运行在正式版中。基于正式版和自测版的这些区别形成这份文档。同时还会介绍一下重构后的前端代码的改进与不足，以及后续更改的方向。</p>
<h4 id="正式版与自测版的区别"><a href="#正式版与自测版的区别" class="headerlink" title="正式版与自测版的区别"></a>正式版与自测版的区别</h4><p>早在前端需要实现flash部分的需求时，我就决定将这部分重构版本的代码来代替已有代码，主要是基于以下考虑：</p>
<ol>
<li><p>架构上不合适，已有代码面向过程，难以拓展和复用。之前的架构是页面拥有一个全局变量admin，然后用它的属性值来保存需要通信的数据，用方法属性来定义过程。  </p>
<ul>
<li>首先流程一旦确定，动态的更改流程将会非常复杂，例如在flash播放中flash和img播放大部分地方相同，除了不需要轮训getrtmp，以及在播放完成时需要killclient之外和flash均一致。已有代码可以完成任务，只是需要在部分流程中判断一下是否img播放环境，但是这样一判断的话，后续如果img环境支持flash播放，那么需要对这个函数更改，去掉判断部分。针对这种情形，结合当前的开发场景，我只能想到用面向对象的继承和多态去解决。而且流程固定，不适应快速的开发，加减流程中的某一个步骤都需要更改业务代码。  </li>
<li>其次全局变量相当危险，任何代码均对其属性进行更改，难以控制。  </li>
<li>全局变量不易维护，我思考了一下如果要使用这个方法来实现flash中的流程，全局变量的属性可能需要增加40-50个，这是什么概念，就是你过了一个星期再去看这个代码，你会发现你就不认识这个变量了。还有就是新人接手代码的时候，他需要40-50个分身去跟踪了解各个变量。  </li>
<li>最后每个ajax请求代码都相当难以复用，因为其中包含了这个流程更迭部分，已经具体到了下一步应该做什么（可以去看看getMyList接口）。</li>
</ul>
</li>
<li><p>两份代码维护一个业务。之前由于需要在chrome和edge浏览器上（后续统称为CE环境）显示一个不支持的提示，遵守开关-关闭原则的话，最小改动是在所有业务代码的运行之前判断用户环境，如果是CE环境，则运行新的代码。你问我为什么不在同一份代码维护，因为这个改动需要在关键函数（getMylist完成后的回调）中加环境判断，代码侵入性非常大。于是乎在一个新的js代码中需要实现大量与之前的tpcamera-admin.js相同的业务，只有少量的业务（i.e.播放视频时提示和省去插件下载与更新的提示）。这样做了之后，后患无穷。在tpcamera-admin.js中更改和新增的业务在CE环境中需要更新。经常出现改了A忘了B，难以控制一致性。为此出了多个bug。（看到这个就知道旧代码得有多难改，一个这么小的需求，我们都宁愿开新的逻辑环境来完成，更勿论复杂N倍的的flash,img播放了）。</p>
</li>
<li>改动非常大，不如新写一个，况且已经完成了一部分了。已经写完其他页面了，模块和业务的划分会更加清晰，我相信可以写好。</li>
</ol>
<p>所幸不辱使命，这部分最核心的代码还是完成并经过在年前提测。其中出了很多BUG，我需要在这里解释一下：</p>
<ol>
<li>大部分bug是功能性的bug，即未完成某个需求，详情请见bugzilla中关于插件观看的大部分bug。  <ul>
<li>首先这个是可以避免的，我完全可以在判断用户的环境的之后让不同环境的用户进入不同的页面。CE环境运行重构的代码，非CE环境使用之前稳定的代码（tpcamera-admin.php）。这样至少可以规避10+的bug。  </li>
<li>其次，我是贪心的。我要在一个页面的逻辑中完成account管理、flash播放，img播放，插件播放。这样后续需求更改就不用维护两份代码（重构部分和tpcamera-admin部分）。所以出bug是可预见的，因为我一个人完成这个事情时间有限，未充分自测。<br>基于易维护、易拓展和便于交接我认为出这些bug的代价是值得的。</li>
</ul>
</li>
<li>对不同的机型配置理解有歧义，部分机型配置成mixed，实际上还是双路码流上传。</li>
<li><p>踩了插件的坑。前端和插件的通信方式是：插件在js中是一个对象，前端需要传递什么值过去就是给这个对象的特定属性赋值，例如将设备的本地信息传入，这样插件就可以尝试本地播放视频。而插件对象的这些属性在前端是不可见的，例如<code>console.log(pluginObj.clddevid)</code>输出是<code>undefined</code>。  </p>
<ul>
<li>我在给插件属性赋值时，未区分IE插件和非IE插件，直接赋值，导致bug。即有些属性streamtype、streamresolution、audiostreamtype不能给IE插件赋值，只能给非IE插件赋值。  </li>
<li>我在调用函数前会习惯性的判断该函数方法是否存在，同样调用插件方法时判断了一下，就直接导致该方法没有调用。</li>
</ul>
</li>
<li><p>未详细的阅读文档，接口返回值中带有协议头，而自以为不带协议头，虽然自测时没有出现问题。</p>
</li>
</ol>
<h5 id="正式版与重构版相同的地方"><a href="#正式版与重构版相同的地方" class="headerlink" title="正式版与重构版相同的地方"></a>正式版与重构版相同的地方</h5><p>从文件的角度上来说有以下文件是一致的(肯定不是完全一样，比如说目录结构的变化导致CSS中引用资源的变化，接口区别等等)：</p>
<ul>
<li>admin-common.css（资源路径区别）</li>
<li>admin.css（资源路径区别）</li>
<li>ipc-jwplayer-skin.css （完全一样）</li>
<li>jquery-ui.min.css（完全一样）</li>
<li>msg.css （资源路径的区别）</li>
<li>product-img.css （资源路径的区别）</li>
<li>admin.js （接口字段变化）</li>
<li>ipc-basic-libs.js （完全一样）</li>
<li>ipc-info-libs.js （重构版本增加了几条提示）</li>
<li>公共库（完全一样，包括jquery-ui-1.11.4.custom.min.js，jwplayer.flash.swf， jwplayer.js， jwpsrv.js）</li>
<li>msg.js （仅做了代码风格上的更改）</li>
</ul>
<h5 id="正式版与重构版不同的地方"><a href="#正式版与重构版不同的地方" class="headerlink" title="正式版与重构版不同的地方"></a>正式版与重构版不同的地方</h5><ul>
<li>目录结构</li>
<li>与后端的php代码解耦</li>
<li>接口变动（因为后台更改，所以接口有些不一样）</li>
<li>POST提交的数据类型不一样，正式版是form表单形式，重构版是json形式</li>
<li>ipc-business-libs.js中改动有：<ul>
<li>linkie数据缓存管理。<br><code>Device.prototype.getLocalLinkieData  
Device.prototype.updateLocalLinkieDataList  
Device.prototype.isNeedGetLinkie</code>  </li>
<li>linkie解析。注意没有linkie接口的设备请求音视频的url均使用兼容模式（/stream/getvideo 和 /stream/getaudio）。同时非CE环境不能使用插件播放时，尝试使用flash播放。<br><code>Device.prototype.getProductFromLinkieData // 入口  
Device.prototype.getOrderedPlayerTypeArr  
Device.prototype.dynamicFixPostChannelForMjpeg  
Device.prototype.getPlayerTypeAndPostChannel  
Device.prototype.getMultiPostDataChannel  
Device.prototype.getMixedPostDataChannel  
Device.prototype.getSupportResArr</code>  </li>
<li>获取linkie接口<br><code>Device.prototype.getLinkie</code>  </li>
<li><em>所有请求后台接口的方法，返回值有变动</em> （注意，此处改动比较大）。之前的这些方法返回用户输入验证结果或者空。现在不仅返回验证结果，同时返回发送ajax的js对象，用于查看和控制ajax。以设备的changeName为例：<br><img src="./images/compare-device-changeName.PNG" alt="compare device changeName">  </li>
<li>用户模块中与后台交互的接口有增加。正式版上的重构代码因为只为admin页面服务，所以省略了很多用户模块的接口。现在这个用户模块也会用到像index等页面，所以接口有所增加，增加列表如下：<br><code>User.prototype.register
User.prototype.login
User.prototype.sendActiveEmail
User.prototype.resetPassword
User.prototype.forgotPassword
User.prototype.getUser
User.prototype.encryptText</code>  </li>
<li>非插件播放和插件播放流程中均针对linkie做了细微改动。正式版的代码流程在技术亮点中有介绍。现在要在这个流程中新增linkie的步骤。在getRelayUrl的同时获取设备的linkie信息，均成功则继续后面的流程，否则内部重试3次，仍然失败的话大循环重试3次。插件播放类似，改动为：<br><code>NonPluginPlayer.prototype.getRelayUrl
=&gt;
NonPluginPlayer.prototype.getUrlAndLinkie
PluginPlayer.prototype.getDeviceLocalInfo
=&gt;
PluginPlayer.prototype.getLinkieAndLocal</code>  </li>
<li>抽象插件播放和非插件播放方式的同一个基类，用于共享和linkie相关的方法。</li>
</ul>
</li>
</ul>
<pre><code class="javascript">(<span class="function"><span class="keyword">function</span>(<span class="params">$</span>) </span>{
<span class="meta">    "use strict"</span>;
    $.ipc = $.ipc || {};
    <span class="function"><span class="keyword">function</span> <span class="title">MyPlayer</span>(<span class="params"></span>) </span>{
        $.ipc.Model.call(<span class="keyword">this</span>, <span class="built_in">arguments</span>);
        <span class="keyword">this</span>.device = <span class="literal">null</span>;
        <span class="keyword">this</span>.playerObj = <span class="literal">null</span>;
        <span class="keyword">this</span>.stateChangeCallback = $.Callbacks(<span class="string">"unique stopOnFalse"</span>);
    };
    $.ipc.inheritPrototype(MyPlayer, $.ipc.Model);
    MyPlayer.prototype.multiAsyncRequest = <span class="function"><span class="keyword">function</span>(<span class="params">args</span>) </span>{
        $.when.apply($, args.ajaxArr).always(args.always).done(args.success).fail(args.fail);
    };

    MyPlayer.prototype.getDeviceLinkieData = <span class="function"><span class="keyword">function</span>(<span class="params">callbacks</span>) </span>{
        <span class="keyword">var</span> _self = <span class="keyword">this</span>;
        <span class="keyword">var</span> device = _self.device;
        <span class="keyword">if</span> (device &amp;&amp; device.owner.token &amp;&amp; device.appServerUrl) {
            <span class="keyword">if</span> (device.isNeedGetLinkie()) {
                <span class="keyword">var</span> result = device.getLinkie({
                    <span class="string">"id"</span>: device.id,
                    <span class="string">"token"</span>: device.owner.token,
                    <span class="string">"appServerUrl"</span>: device.appServerUrl
                }, callbacks)[<span class="string">"ajaxObj"</span>];
                <span class="keyword">return</span> result;
            };
        };
    };

    $.ipc.MyPlayer = MyPlayer;
})(jQuery);
</code></pre>
<p>等等等，正式版使用的admin的git版本号为ceb631a5，后续改动可以查阅git仓库）。</p>
<ul>
<li>除admin页面之外均只属于自测</li>
<li>admin页面中后续更改了以下地方  <ul>
<li>admin.js中只是字段名变化（做过一次代码风格整理，同时因为请求后台接口的方法返回值有改动，做了相应的更改）</li>
<li>从php变成html（资源路径不一致，php代码在返回html之前先判断了session信息）</li>
<li>css中只有资源引用位置的更改。</li>
</ul>
</li>
</ul>
<h4 id="重构后得到的改进与不足"><a href="#重构后得到的改进与不足" class="headerlink" title="重构后得到的改进与不足"></a>重构后得到的改进与不足</h4><p>前端的代码的重构周期已经告了一个段落。现在我可以从我的角度来对它进行定论。好与不好暂时只有我自己知道。我就从我自己的使用经验来总结一下。</p>
<h5 id="重构代码取得的改进。"><a href="#重构代码取得的改进。" class="headerlink" title="重构代码取得的改进。"></a>重构代码取得的改进。</h5><ul>
<li>从面向过程到面向对象。较大程度的提升了代码的可复用和易维护与可拓展。使用前人总结的面向对象的编程原则(S.O.L.I.D)，可以很好地编写代码。同时使用MVC的架构，可以清晰的每个部分的职责与合作方式。Model用于存储数据和DAO，Controller则监听用户输入，控制view和model做相应的更改，View控制显示方式。</li>
<li>解决缓存问题，定制发布规则。已有代码在版本更新时只会在获取CDN资源的时候会带上部署时的时间戳，这样只能解决新代码不会使用旧文件的问题，而不能解决旧代码会使用新文件的问题。于是重构的时候会在文件名称上带上文件指纹（内容的md5值）。这样可以充分的利用缓存，同时还不会导致错误的缓存使用。同时我们还可以制定发布规则，使得开发环境和生产环境目录结构不一样，例如我们可以将静态文件的代码发布至带有版本信息的路径上，之后cdn维护就可以针对性的删除旧版本的文件。</li>
<li>性能提升。fis3的构建过程带来的性能提升是非常明显的，可以对静态文件进行压缩（甚至可以内联），节省服务器带宽，减少客户端的请求次数。</li>
<li>有管理复杂流程的能力。不管是其中步骤的复用，还是增/删步骤。由于状态机的引入，可以解耦每个步骤，方便的管理或复用每个步骤。</li>
<li>html模板的模板化开发。提取出公共模板进行统一维护。在离线发布的时候完成这些html模板的继承与拓展。</li>
<li>多语言的拓展。保留了多语言的接口，可动态的一键切换语言，动态的加载语言包，完成之后替换语言。</li>
</ul>
<h5 id="重构代码还有哪些不足"><a href="#重构代码还有哪些不足" class="headerlink" title="重构代码还有哪些不足"></a>重构代码还有哪些不足</h5><ul>
<li>前端代码的组件化开发。前端的需求日益复杂，可能是一个团队在开发维护，存在多人协同合作完成任务，那么组件化开发相当必要。关于前端代码的组件化，可以看<a href="http://www.zhihu.com/question/29735633?sort=created" target="_blank" rel="external">这里</a>。</li>
<li>面向对象设计之后，模块非常多，导致模块之间的依赖关系复杂，有一些设计不一定合理，但是会直接有效率，所以就没有做到充分抽象，合理区分模块。这一块还需要更多的思考与重构。</li>
<li>自适应，往web-app的方向发展。大势所趋吧，对于这方面我还没有什么研究。</li>
<li>没有找到一个合适的对象私有变量实现方法。所有的对象数据成员变量均对外可见。</li>
<li>从admin页面可以看出：大部分的代码还是在于View中控制显示流程和执行的DOM操作。需要从这个方向获得优化。</li>
<li>CSS编写需要预处理框架。我们需要less或者sass，来为 CSS 增加一些编程的的特性，无需考虑浏览器的兼容性问题，例如你可以在 CSS 中使用变量、简单的程序逻辑、函数等等在编程语言中的一些基本技巧，可以让你的 CSS 更见简洁，适应性更强，代码更直观等诸多好处。</li>
</ul>
<h5 id="重构代码中未完成部分"><a href="#重构代码中未完成部分" class="headerlink" title="重构代码中未完成部分"></a>重构代码中未完成部分</h5><ul>
<li>需要额外处理flash在setupPlayer中可能会遇到的setup的问题，例如未安装flash等，需要做相关的回调显示提示等。</li>
<li>多语言所有显示文本的html标签中需要lang=”en”属性，可能有未完成的地方。同时因为多语言可能会导致排版变动等。</li>
<li>需求中未提到的。当用户在使用linux系统的浏览器时，该如何提示给用户告知环境不支持播放？</li>
<li>在git分支’使用require进行按需加载’中开发了使用requirejs进行按需加载模块，管理模块依赖，只自测了核心的功能。</li>
</ul>
<h5 id="未来涉可能的变动"><a href="#未来涉可能的变动" class="headerlink" title="未来涉可能的变动"></a>未来涉可能的变动</h5><ul>
<li>不仅仅是CE环境使用flash播放，所有环境使用flash或者img。此时应该修改<code>Device.prototype.getOrderedPlayerTypeArr</code>的环境判断与返回值。</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ipc-web/">ipc-web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/front-end/">前端</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/refactor/">重构</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/javascript/">javascript</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-ipc-web重构 (七) 技术亮点" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/22/ipc-web重构 (七) 技术亮点/" class="article-date">
  	<time datetime="2016-04-22T08:18:39.000Z" itemprop="datePublished">2016-04-22</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/22/ipc-web重构 (七) 技术亮点/">ipc-web重构 (七) 技术亮点</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><br>在重构时会遇到各种需求，这就使得我去思考一些比较好的解决方法。于是在解决问题的过程中出现了一些亮点。有一部分的理念是来源于后台的MVC框架，java的springMVC。</p>
<h4 id="方法执行链"><a href="#方法执行链" class="headerlink" title="方法执行链"></a>方法执行链</h4><p>单一职责是设计原则中的一个简单而重要的原则。通常一个方法只为了完成一个简单的业务。举个例子来说，对超链接的a节点点击事件之后的业务逻辑应该只有跳转页面。但是在上一章提到的一个场景：有可能这个跳转操作是一个非法操作，不应该被执行。那么通常的做法是在这个跳转的逻辑中加一个判断，如果本操作合法则跳转，非法则不跳转:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sample</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// business logic</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>变成</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sample</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> r = confirm(<span class="string">"Are you sure?"</span>);</span><br><span class="line">    <span class="keyword">if</span>(r) &#123;</span><br><span class="line">        <span class="comment">// business logic</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样做不符合单一职责，在sample中做了两个业务逻辑，也不符合开放-关闭原则：例如在合法和非法的判断条件变化时需要进入代码进行更改。</p>
<p>一个好的解决方法是利用面向切面的概念形成一个方法执行链。我们将跳转逻辑的方法作为一个切面点，切面点之前的操作方法A、切面点B、切面点之后的操作方法C形成一个方法执行链，A成功之后执行B，B成功之后执行C。如果其中一个失败则后续的操作不执行。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sample</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// business logic</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>变成：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sample</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// business logic</span></span><br><span class="line">&#125;</span><br><span class="line">sample = (sample || <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;).before(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> confirm(<span class="string">"Are you sure?"</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>其中切面before和after的代码如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">Function</span>.prototype.before = <span class="function"><span class="keyword">function</span>(<span class="params">func</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> _self = <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (func.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>) === <span class="literal">false</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> _self.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Function</span>.prototype.after = <span class="function"><span class="keyword">function</span>(<span class="params">func</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> _self = <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> ret = _self.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">            <span class="keyword">if</span> (ret === <span class="literal">false</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;;</span><br><span class="line">            func.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">            <span class="keyword">return</span> ret;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure></p>
<h4 id="Js中的协程"><a href="#Js中的协程" class="headerlink" title="Js中的协程"></a>Js中的协程</h4><p>协程的概念是将函数或者方法暂停在一个点(yield)，然后下次调用的时候继续从暂停点执行。举例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">foo</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (index &lt;= <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">yield</span> index++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述代码定义了一个协程方法，定义完成之后可以通过迭代器方式使用：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> iterator = foo();</span><br><span class="line"><span class="built_in">console</span>.log(iterator.next()); <span class="comment">// &#123; value: 0, done: false &#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(iterator.next()); <span class="comment">// &#123; value: 1, done: false &#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(iterator.next()); <span class="comment">// &#123; value: 2, done: false &#125;</span></span><br><span class="line"><span class="built_in">console</span>.log(iterator.next()); <span class="comment">// &#123; value: undefined, done: true &#125;</span></span><br></pre></td></tr></table></figure>
<p>有了协程之后，异步的代码就可以用同步的方式写了：</p>
<h4 id="流程设计"><a href="#流程设计" class="headerlink" title="流程设计"></a>流程设计</h4><p>在flash直播方案中，从用户开启观看，到音视频到达用户浏览器端有一个比较复杂的请求流程，如图：</p>
<p><img src="images/rtmp-process-flow.png" alt="rtmp process flow"></p>
<p>该流程中详细描述了两个处理流。</p>
<ul>
<li><p>开启RTMP直播流<br>1 WEB前端发起requestUrl请求,获取relay地址。<br>2 WEB前端发起requestRelayService请求，app-server(devs-server)启动设备中relayd进程。<br>3 Device返回elbcookie至app-server(devs-server)。<br>4 WEB前端发起isRelayRelay请求，获得设备连接的Relay服务的AWS elbcookie。<br>5 Device开始POST多路或单路流至relay；Web前端通过web后台中转发送getrtmp请求至relay，轮训获得A/V的resourceid。<br>6 Relay获取流成功后生成resourceid，并通知librtmp。<br>7 Librtmp获取通知后，向relay发送get请求获取流。<br>8 Librtmp publish流至red5。<br>9 Web前端尝试RTMP连接，成功后即播放直播流。</p>
</li>
<li><p>关闭直播流<br>1) Web前端将rtmp流状态置为stop。<br>2) Red5计数将客户端数目减一。<br>3) Red5捕捉client数目为0的事件，停止librtmp的publish。<br>4) Librtmp捕捉publish被停止事件停止向relay发送get请求。<br>5) Relay监听设备POST超时事件，停止响应设备的POST请求。</p>
</li>
</ul>
<p>前端处于应用顶端，受网络因素影响较大，请求超时比较常见，同时因为上述交互流程较为复杂，一步错则步步错，所以健壮的超时及错误回调策略比较重要。前端针对超时及错误的重试如下图：</p>
<p><img src="images/flash-flow-retry.png" alt="flash-flow-retry"></p>
<ol>
<li>针对requestUrl和requestRelayService如果未取回正确结果(包括xhr超时，网络错误等)，会重新发送该请求最多3次。</li>
<li>IsRelayReady请求轮训每1秒一次，总共6s之内未取回正确结果则重新从requestRelayService开始尝试，此类型重试限制为3次。</li>
<li>RTMPOPERATE请求轮训每3秒一次，9秒内未正确取回结果，则重新从requestRelayService开始尝试，此类型重试限制为3次。</li>
<li>在请求的过程中出现1.请求流中出现异常(已完成小循环重试，内部循环重试)，2.视频播放中出现异常(异常complete，网络错误，publish中断等)，均会进行大循环重试。</li>
<li>网页视频播放器直播视频，中途出现网络错误，异常终止时，页面显示网络错误提示。</li>
</ol>
<h4 id="状态机"><a href="#状态机" class="headerlink" title="状态机"></a>状态机</h4><p>这些设计具体到代码上就是前端实现了一个状态迁移机。状态通过某个方法进行状态迁移，具体的状态迁移如图：</p>
<p><img src="images/state-change.png" alt="state-change"></p>
<p>其中白色背景的长方形表示状态，灰色背景长方形表示方法。实线表示成功时迁移方向，虚线代表错误发生时的迁移方向。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ipc-web/">ipc-web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/front-end/">前端</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/refactor/">重构</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/javascript/">javascript</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-ipc-web重构 (六) 基础组件建设" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/22/ipc-web重构 (六) 基础组件建设/" class="article-date">
  	<time datetime="2016-04-22T02:04:47.000Z" itemprop="datePublished">2016-04-22</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/22/ipc-web重构 (六) 基础组件建设/">ipc-web重构 (六) 基础组件建设</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><br>因为在ipc-web前端的需求中明确定义了各种UI组件的显示与交互方式，同时要求需要对IE8兼容(前端开发人员的噩耗)。所以为了高保真的还原这些设计，我们需要自己定制各种UI组件，例如弹窗类(包括confirm, alert, info)，select等。</p>
<h4 id="UI组件"><a href="#UI组件" class="headerlink" title="UI组件"></a>UI组件</h4><p>开发这些组件可以以jQuery插件的方式来进行拓展，而且github有相当多的优秀的jquery插件。要很好的利用这些资源，因为遇到问题可以很快的上面找到答案，同时可以向优秀的人学习他们的思维方式。</p>
<ul>
<li><p>jQuery插件拓展基本方式如下:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jQuery.fn.myPlugin = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">   <span class="comment">// 插件代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是为了避免和其他库中的<code>$</code>冲突的话，可以将jQuery作为参数传递给一个自我执行的封闭程序，jQuery在此程序中映射为<code>$</code>符号，这样可以避免<code>$</code>号被其他库覆写，如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">$</span>) </span>&#123;</span><br><span class="line">    $.fn.myPlugin = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 插件代码</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)(jQuery);</span><br></pre></td></tr></table></figure>
<p>本项目的基础组件代码请查询select.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">$</span>) </span>&#123;</span><br><span class="line"><span class="meta">    "use strict"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> tmpSelect = &#123;</span><br><span class="line">        mainTemplate: <span class="string">'&lt;div class="plugin-select"&gt;'</span> +</span><br><span class="line">            <span class="string">'&lt;div class="selected"&gt;&lt;span lang="en"&gt;&lt;/span&gt;&lt;/div&gt;'</span> +</span><br><span class="line">            <span class="string">'&lt;div class="triangle"&gt;&lt;/div&gt;'</span> +</span><br><span class="line">            <span class="string">'&lt;div class="slide"&gt;'</span> +</span><br><span class="line">            <span class="string">'&lt;div class="slide-item-holder"&gt;&lt;/div&gt;'</span> +</span><br><span class="line">            <span class="string">'&lt;/div&gt;'</span> +</span><br><span class="line">            <span class="string">'&lt;div class="expand-collapse"&gt;&lt;/div&gt;'</span> +</span><br><span class="line">            <span class="string">'&lt;/div&gt;'</span>,</span><br><span class="line">        optionTemplate: <span class="string">'&lt;div class="slide-item" xvalue=""&gt;&lt;span lang="en"&gt;&lt;/span&gt;&lt;/div&gt;'</span>,</span><br><span class="line">        uniqueAttrKey: <span class="string">'only-for-plugin-select'</span>,</span><br><span class="line">        uniqueAttrValuePrefix: <span class="string">'i-am-unique-'</span>,</span><br><span class="line">        collapse: <span class="function"><span class="keyword">function</span>(<span class="params">select</span>) </span>&#123;</span><br><span class="line">            select.removeClass(<span class="string">"select-slide"</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        addSelectOptionElements: <span class="function"><span class="keyword">function</span>(<span class="params">select, selectOptionElements</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> htmlStr = <span class="string">""</span>;</span><br><span class="line">            selectOptionElements.each(<span class="function"><span class="keyword">function</span>(<span class="params">i</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> ($(<span class="keyword">this</span>).css(<span class="string">"display"</span>) != <span class="string">"none"</span>) &#123;</span><br><span class="line">                    htmlStr += <span class="string">'&lt;div class="slide-item" xvalue="'</span> + </span><br><span class="line">                       $(<span class="keyword">this</span>).attr(<span class="string">"value"</span>) + <span class="string">'"&gt;&lt;span lang="en"&gt;'</span> + </span><br><span class="line">                       $(<span class="keyword">this</span>).html() + <span class="string">'&lt;/span&gt;&lt;/div&gt;'</span>;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;);</span><br><span class="line">            select.find(<span class="string">".slide-item-holder"</span>).append(htmlStr);</span><br><span class="line">        &#125;,</span><br><span class="line">        addSelectOptionForOrigin: <span class="function"><span class="keyword">function</span>(<span class="params">originSelect, selectOptionElements</span>) </span>&#123;</span><br><span class="line">            originSelect.append(selectOptionElements);</span><br><span class="line">        &#125;,</span><br><span class="line">        changeFromOrigin: <span class="function"><span class="keyword">function</span>(<span class="params">select, originSelect</span>) </span>&#123;</span><br><span class="line">            originSelect.change(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                tmpSelect.feedSelectValue(select, originSelect);</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;,</span><br><span class="line">        expand: <span class="function"><span class="keyword">function</span>(<span class="params">select</span>) </span>&#123;</span><br><span class="line">            select.addClass(<span class="string">"select-slide"</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        updateDisplayStyle: <span class="function"><span class="keyword">function</span>(<span class="params">select, _options, originSelect</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> pluginSelectWidth = originSelect.width() == <span class="number">0</span> ? </span><br><span class="line">               _options.pluginSelectWidth : originSelect.outerWidth();</span><br><span class="line">            <span class="keyword">var</span> maxDisplayContainerWidth = _options.optionWidth || pluginSelectWidth;</span><br><span class="line">            <span class="keyword">var</span> tmpSelectOptionHeight = _options.slideOptionHeight;</span><br><span class="line">            <span class="keyword">var</span> totalOptionHeightWithoutScroll = (tmpSelectOptionHeight + <span class="number">8</span>) * </span><br><span class="line">               select.find(<span class="string">".slide-item"</span>).length;</span><br><span class="line">            <span class="keyword">var</span> maxDisplayContainerHeight = <span class="built_in">Math</span>.min(_options.slideMaxHeight, </span><br><span class="line">               totalOptionHeightWithoutScroll);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">undefined</span> == pluginSelectWidth || pluginSelectWidth &lt;= <span class="number">30</span> ||</span><br><span class="line">                <span class="literal">undefined</span> == maxDisplayContainerWidth ||</span><br><span class="line">                <span class="literal">undefined</span> == tmpSelectOptionHeight || <span class="literal">undefined</span> == totalOptionHeightWithoutScroll ||</span><br><span class="line">                <span class="literal">undefined</span> == maxDisplayContainerHeight) &#123;</span><br><span class="line">                <span class="built_in">console</span>.error(<span class="string">"args error for init plugin-select"</span>);</span><br><span class="line">            &#125;;</span><br><span class="line">            select.width(pluginSelectWidth);</span><br><span class="line">            select.find(<span class="string">".selected"</span>).width(pluginSelectWidth - <span class="number">30</span>);</span><br><span class="line">            select.find(<span class="string">".slide"</span>).width(maxDisplayContainerWidth)</span><br><span class="line">               .height(maxDisplayContainerHeight);</span><br><span class="line">            select.find(<span class="string">".slide-item"</span>).height(tmpSelectOptionHeight);</span><br><span class="line">            select.find(<span class="string">".slide-item-holder"</span>).width(maxDisplayContainerWidth)</span><br><span class="line">               .height(totalOptionHeightWithoutScroll);</span><br><span class="line">            select.css(<span class="string">"position"</span>, originSelect.css(<span class="string">"position"</span>));</span><br><span class="line">            select.css(<span class="string">"left"</span>, originSelect.css(<span class="string">"left"</span>));</span><br><span class="line">            select.css(<span class="string">"top"</span>, originSelect.css(<span class="string">"top"</span>));</span><br><span class="line">        &#125;,</span><br><span class="line">        generateAddedOptionElements: <span class="function"><span class="keyword">function</span>(<span class="params">addedOptions</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">undefined</span> == addedOptions) &#123;</span><br><span class="line">                <span class="keyword">return</span> $(<span class="string">""</span>);</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">var</span> optionPrefix = <span class="string">"&lt;option&gt;"</span>;</span><br><span class="line">            <span class="keyword">var</span> optionPostfix = <span class="string">"&lt;/option&gt;"</span>;</span><br><span class="line">            <span class="keyword">var</span> htmlStr = <span class="string">""</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> addedOptions) &#123;</span><br><span class="line">                htmlStr += optionPrefix + key + optionPostfix;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> $(htmlStr);</span><br><span class="line">        &#125;,</span><br><span class="line">        feedSelectValue: <span class="function"><span class="keyword">function</span>(<span class="params">select, originSelect</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> selectedValue;</span><br><span class="line">            <span class="keyword">if</span> (originSelect.val()) &#123;</span><br><span class="line">                selectedValue = originSelect.find(<span class="string">":selected"</span>).html() || originSelect.val();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                selectedValue = originSelect.find(<span class="string">"option:first"</span>).html();</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            select.find(<span class="string">".selected span"</span>).html(selectedValue);</span><br><span class="line">        &#125;,</span><br><span class="line">        feedTemplate: <span class="function"><span class="keyword">function</span>(<span class="params">select, originSelect, options</span>) </span>&#123;</span><br><span class="line">            select.toggleClass(<span class="string">"select-disabled"</span>, options.disabled);</span><br><span class="line">            tmpSelect.feedSelectValue(select, originSelect);</span><br><span class="line">        &#125;,</span><br><span class="line">        generatePluginConstructOption: <span class="function"><span class="keyword">function</span>(<span class="params">options, originSelect</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> _options = $.extend(<span class="literal">true</span>, &#123;&#125;, $.fn.Select.defaults, options)</span><br><span class="line">            <span class="keyword">var</span> optionWidth = originSelect.attr(<span class="string">"select-width"</span>);</span><br><span class="line">            <span class="keyword">if</span> (optionWidth) &#123;</span><br><span class="line">                _options.optionWidth = <span class="built_in">parseInt</span>(optionWidth);</span><br><span class="line">            &#125;;</span><br><span class="line">            _options.disabled = originSelect.attr(<span class="string">"disabled"</span>) == <span class="string">"disabled"</span>;</span><br><span class="line">            <span class="keyword">return</span> _options;</span><br><span class="line">        &#125;,</span><br><span class="line">        generateSelectId: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> tmpSelect.uniqueAttrValuePrefix + $.now() + <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">6</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        onClick: <span class="function"><span class="keyword">function</span>(<span class="params">select, e, originSelect</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> screenAvailableHeight = screen.availHeight;</span><br><span class="line">            <span class="keyword">var</span> selectPositionY = e.pageY;</span><br><span class="line">            <span class="keyword">var</span> slideContainer = select.find(<span class="string">".slide"</span>);</span><br><span class="line">            <span class="keyword">if</span> (screenAvailableHeight - selectPositionY &lt; slideContainer.height()) &#123;</span><br><span class="line">                slideContainer.css(&#123;</span><br><span class="line">                    <span class="string">"bottom"</span>: select.height(),</span><br><span class="line">                    <span class="string">"top"</span>: <span class="string">""</span></span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                slideContainer.css(&#123;</span><br><span class="line">                    <span class="string">"top"</span>: select.height(),</span><br><span class="line">                    <span class="string">"bottom"</span>: <span class="string">""</span></span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (select.hasClass(<span class="string">"select-slide"</span>)) &#123;</span><br><span class="line">                select.removeClass(<span class="string">"select-slide"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $(<span class="string">".select-slide"</span>).removeClass(<span class="string">"select-slide"</span>);</span><br><span class="line">                select.addClass(<span class="string">"select-slide"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            originSelect.focus();</span><br><span class="line"></span><br><span class="line">            e.stopPropagation();</span><br><span class="line">        &#125;,</span><br><span class="line">        onOptionClick: <span class="function"><span class="keyword">function</span>(<span class="params">select, e, originSelect, selectedOption</span>) </span>&#123;</span><br><span class="line">            select.removeClass(<span class="string">"select-slide"</span>);</span><br><span class="line">            <span class="keyword">var</span> value = selectedOption.attr(<span class="string">"xvalue"</span>);</span><br><span class="line">            <span class="keyword">var</span> selectedText = selectedOption.text();</span><br><span class="line">            <span class="keyword">var</span> oldText = select.find(<span class="string">".selected span"</span>).text();</span><br><span class="line">            originSelect.val(value);</span><br><span class="line">            <span class="keyword">if</span> (oldText != selectedText) &#123;</span><br><span class="line">                (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                    originSelect.trigger(<span class="string">"beforeChange"</span>);</span><br><span class="line">                    <span class="keyword">return</span> originSelect.data(<span class="string">"canChange"</span>);</span><br><span class="line">                &#125;).after(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                    originSelect.change();</span><br><span class="line">                    select.find(<span class="string">".selected span"</span>).text(selectedText);</span><br><span class="line">                &#125;)();</span><br><span class="line">            &#125;;</span><br><span class="line">            e.stopPropagation();</span><br><span class="line">        &#125;,</span><br><span class="line">        addScrollbar: <span class="function"><span class="keyword">function</span>(<span class="params">select</span>) </span>&#123;</span><br><span class="line">            select.find(<span class="string">".slide"</span>).Scrollbar(&#123;</span><br><span class="line">                target: select.find(<span class="string">".slide .slide-item-holder"</span>)</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> bodyClicking = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    $.fn.Select = <span class="function"><span class="keyword">function</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> originSelect = $(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">var</span> _options = tmpSelect.generatePluginConstructOption(options, originSelect);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> id = originSelect.attr(tmpSelect.uniqueAttrKey) || tmpSelect.generateSelectId();</span><br><span class="line">        <span class="keyword">if</span> ($(<span class="string">"#"</span> + id).length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            $(<span class="string">"#"</span> + id).remove();</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> select = $(tmpSelect.mainTemplate);</span><br><span class="line"></span><br><span class="line">        select.attr(<span class="string">"id"</span>, id);</span><br><span class="line">        originSelect.attr(tmpSelect.uniqueAttrKey, id);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> addedOptionElements = tmpSelect.generateAddedOptionElements(_options.addedOptions);</span><br><span class="line">        tmpSelect.addSelectOptionForOrigin(originSelect, addedOptionElements);</span><br><span class="line"></span><br><span class="line">        tmpSelect.feedTemplate(select, originSelect, _options);</span><br><span class="line"></span><br><span class="line">        tmpSelect.addSelectOptionElements(select, originSelect.find(<span class="string">"option"</span>));</span><br><span class="line"></span><br><span class="line">        tmpSelect.updateDisplayStyle(select, _options, originSelect);</span><br><span class="line">        tmpSelect.addScrollbar(select);</span><br><span class="line"></span><br><span class="line">        select.insertBefore(originSelect);</span><br><span class="line"></span><br><span class="line">        select.on(<span class="string">'mouseup'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            bodyClicking = <span class="literal">false</span>;</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        $(<span class="string">'.expand-collapse'</span>, select).on(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">            tmpSelect.onClick(select, e, originSelect);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        $(<span class="string">'.slide-item'</span>, select).on(<span class="string">'mousedown'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">            tmpSelect.onOptionClick(select, e, originSelect, $(<span class="keyword">this</span>));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        tmpSelect.changeFromOrigin(select, originSelect);</span><br><span class="line">        originSelect.hide();</span><br><span class="line">        tmpSelect.collapse(select);</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    $.fn.Select.defaults = &#123;</span><br><span class="line">        pluginSelectWidth: <span class="number">200</span>,</span><br><span class="line">        optionWidth: <span class="literal">null</span>,</span><br><span class="line">        slideMaxHeight: <span class="number">288</span>,</span><br><span class="line">        slideOptionHeight: <span class="number">16</span>,</span><br><span class="line">        hotKey: <span class="literal">false</span>,</span><br><span class="line">        disabled: <span class="literal">false</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    $(<span class="built_in">document</span>).on(<span class="string">"mousedown"</span>, <span class="string">"body"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        bodyClicking = <span class="literal">true</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    $(<span class="built_in">document</span>).on(<span class="string">"mouseup"</span>, <span class="string">"body"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (bodyClicking) &#123;</span><br><span class="line">            $(<span class="string">'div.select-slide'</span>).removeClass(<span class="string">"select-slide"</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;)(jQuery);</span><br></pre></td></tr></table></figure>
<p>以及msg.js。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"> (<span class="function"><span class="keyword">function</span>(<span class="params">$</span>) </span>&#123;</span><br><span class="line"><span class="meta">     "use strict"</span>;</span><br><span class="line"></span><br><span class="line">     $.ipc = $.ipc || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">var</span> Msg = &#123;</span><br><span class="line">         ID: <span class="number">0</span>,</span><br><span class="line">         mainTemplate: <span class="string">'&lt;div &gt;'</span> +</span><br><span class="line">             <span class="string">'&lt;div class="window-msg-bg"&gt;&lt;/div&gt;'</span> +</span><br><span class="line">             <span class="string">'&lt;div class="window-msg-holder"&gt;'</span> +</span><br><span class="line">             <span class="string">'&lt;div class="window-msg-contain"&gt;'</span> +</span><br><span class="line">             <span class="string">'&lt;div class="window-msg-head"&gt;'</span> +</span><br><span class="line">             <span class="string">'&lt;span class="window-msg-head-title" lang="en"&gt;&lt;/span&gt;'</span> +</span><br><span class="line">             <span class="string">'&lt;/div&gt;'</span> +</span><br><span class="line">             <span class="string">'&lt;div class="window-msg-body"&gt;'</span> +</span><br><span class="line">             <span class="string">'&lt;div class="window-msg-body-content"&gt;&lt;span lang="en"&gt;'</span> +</span><br><span class="line">             <span class="string">'&lt;/span&gt;&lt;/div&gt;'</span> +</span><br><span class="line">             <span class="string">'&lt;/div&gt;'</span> +</span><br><span class="line">             <span class="string">'&lt;div class="window-msg-body-foot"&gt;'</span> +</span><br><span class="line">             <span class="string">'&lt;/div&gt;'</span> +</span><br><span class="line">             <span class="string">'&lt;/div&gt;'</span> +</span><br><span class="line">             <span class="string">'&lt;/div&gt;'</span> +</span><br><span class="line">             <span class="string">'&lt;/div&gt;'</span>,</span><br><span class="line">         closeIconTemplate: <span class="string">'&lt;span class="window-msg-head-close"&gt;&lt;/span&gt;'</span>,</span><br><span class="line">         btnTemplate: <span class="string">'&lt;input class="window-msg-btn" value="OK" lang="en" type="button" /&gt;'</span>,</span><br><span class="line">         close: <span class="function"><span class="keyword">function</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">             <span class="keyword">var</span> context = msg.parent();</span><br><span class="line">             $(<span class="string">'body'</span>).unbind(<span class="string">'keydown'</span>, Msg.hotClose);</span><br><span class="line">             msg.remove();</span><br><span class="line">             msg.option.afterClose();</span><br><span class="line">             <span class="keyword">return</span> context;</span><br><span class="line">         &#125;,</span><br><span class="line">         cancel: <span class="function"><span class="keyword">function</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">             <span class="keyword">var</span> context = msg.parent();</span><br><span class="line">             msg.option.cancel();</span><br><span class="line">             <span class="keyword">return</span> Msg.close(msg);</span><br><span class="line">         &#125;,</span><br><span class="line">         confirm: <span class="function"><span class="keyword">function</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">             <span class="keyword">var</span> context = msg.parent();</span><br><span class="line">             msg.option.confirm();</span><br><span class="line">             <span class="keyword">return</span> Msg.close(msg);</span><br><span class="line">         &#125;,</span><br><span class="line">         ok: <span class="function"><span class="keyword">function</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">             <span class="keyword">var</span> context = msg.parent();</span><br><span class="line">             msg.option.ok();</span><br><span class="line">             <span class="keyword">return</span> Msg.close(msg);</span><br><span class="line">         &#125;,</span><br><span class="line">         hotClose: <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">             <span class="keyword">if</span> (event.keyCode == <span class="string">"27"</span>) &#123;</span><br><span class="line">                 Msg.close(event.data.msg);</span><br><span class="line">             &#125;;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">     &#125;;</span><br><span class="line"></span><br><span class="line">     $.ipc.Msg = <span class="function"><span class="keyword">function</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">var</span> _options = $.extend(<span class="literal">true</span>, &#123;&#125;, $.ipc.Msg.defaults, options);</span><br><span class="line"></span><br><span class="line">         <span class="keyword">var</span> id = <span class="string">"Msg-1"</span>;</span><br><span class="line">         <span class="keyword">if</span> ($(<span class="string">"#"</span> + id).length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">             $(<span class="string">"#"</span> + id).remove();</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">var</span> rHtml = Msg.mainTemplate;</span><br><span class="line">         <span class="keyword">var</span> msg = $(rHtml);</span><br><span class="line"></span><br><span class="line">         <span class="comment">//render id, title, info, button and size</span></span><br><span class="line">         msg.attr(<span class="string">"id"</span>, id);</span><br><span class="line">         $(<span class="string">'.window-msg-head-title'</span>, msg).text(_options.title);</span><br><span class="line">         $(<span class="string">'.window-msg-body-content span'</span>, msg).html(_options.info);</span><br><span class="line"></span><br><span class="line">         <span class="keyword">switch</span> (_options.type) &#123;</span><br><span class="line">             <span class="keyword">case</span> <span class="string">"alert"</span>:</span><br><span class="line">                 $(<span class="string">'.window-msg-body-foot'</span>, msg).append(Msg.btnTemplate);</span><br><span class="line">                 $(<span class="string">'.window-msg-btn:first'</span>, msg).attr(<span class="string">"value"</span>, _options.btnOk);</span><br><span class="line">                 $(<span class="string">'.window-msg-btn:first'</span>, msg).attr(<span class="string">"for"</span>, <span class="string">"ok"</span>);</span><br><span class="line">                 <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">             <span class="keyword">case</span> <span class="string">"confirm"</span>:</span><br><span class="line">                 $(<span class="string">'.window-msg-body-foot'</span>, msg).append(Msg.btnTemplate);</span><br><span class="line">                 $(<span class="string">'.window-msg-body-foot'</span>, msg).append(Msg.btnTemplate);</span><br><span class="line">                 $(<span class="string">'.window-msg-btn:first'</span>, msg).attr(<span class="string">"value"</span>, _options.btnCancel);</span><br><span class="line">                 $(<span class="string">'.window-msg-btn:first'</span>, msg).attr(<span class="string">"for"</span>, <span class="string">"cancel"</span>);</span><br><span class="line">                 $(<span class="string">'.window-msg-btn:last'</span>, msg).attr(<span class="string">"value"</span>, _options.btnConfirm);</span><br><span class="line">                 $(<span class="string">'.window-msg-btn:last'</span>, msg).attr(<span class="string">"for"</span>, <span class="string">"confirm"</span>);</span><br><span class="line">                 <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">             <span class="keyword">case</span> <span class="string">"info"</span>:</span><br><span class="line">                 <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">             <span class="keyword">default</span>:</span><br><span class="line">                 $(<span class="string">'.window-msg-body-foot'</span>, msg).append(Msg.btnTemplate);</span><br><span class="line">                 $(<span class="string">'.window-msg-btn:first'</span>, msg).attr(<span class="string">"value"</span>, _options.btnOk);</span><br><span class="line">                 $(<span class="string">'.window-msg-btn:first'</span>, msg).attr(<span class="string">"for"</span>, <span class="string">"ok"</span>);</span><br><span class="line">                 <span class="keyword">break</span>;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         $(<span class="string">'.window-msg-contain'</span>, msg).css(&#123;</span><br><span class="line">             <span class="string">"width"</span>: _options.width,</span><br><span class="line">             <span class="string">"height"</span>: _options.height</span><br><span class="line">         &#125;);</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (_options.closeIcon) &#123;</span><br><span class="line">             $(<span class="string">'.window-msg-head'</span>, msg).append(Msg.closeIconTemplate);</span><br><span class="line">         &#125;;</span><br><span class="line"></span><br><span class="line">         _options.beforeInit();</span><br><span class="line"></span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             msg.appendTo(<span class="string">'body'</span>);</span><br><span class="line">         &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">             <span class="built_in">console</span>.log(e);</span><br><span class="line">             <span class="built_in">console</span>.log(<span class="string">'can not append msg to body'</span>);</span><br><span class="line">             <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         msg.option = _options;</span><br><span class="line"></span><br><span class="line">         <span class="comment">// add object functions. so we can dynamic call these functions.</span></span><br><span class="line">         msg.close = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">             Msg.close(msg);</span><br><span class="line">         &#125;;</span><br><span class="line"></span><br><span class="line">         msg.cancel = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">             Msg.cancel(msg);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         msg.confirm = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">             Msg.confirm(msg);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         msg.ok = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">             Msg.ok(msg);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         $(<span class="string">'.window-msg-btn'</span>, msg).on(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">             e.preventDefault();</span><br><span class="line">             <span class="keyword">var</span> type = $(<span class="keyword">this</span>).attr(<span class="string">"for"</span>);</span><br><span class="line">             Msg[type](msg);</span><br><span class="line">         &#125;);</span><br><span class="line"></span><br><span class="line">         $(<span class="string">'.window-msg-head-close'</span>, msg).on(<span class="string">'click'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">             e.preventDefault();</span><br><span class="line">             Msg.close(msg);</span><br><span class="line">         &#125;);</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (msg.option.hotKey) &#123;</span><br><span class="line">             $(<span class="string">'body'</span>).bind(<span class="string">'keydown'</span>, &#123;</span><br><span class="line">                 msg: msg</span><br><span class="line">             &#125;, Msg.hotClose);</span><br><span class="line">         &#125;;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">return</span> msg;</span><br><span class="line">     &#125;;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// make default options writable outside</span></span><br><span class="line">     $.ipc.Msg.defaults = &#123;</span><br><span class="line">         type: <span class="string">"alert"</span>,</span><br><span class="line">         title: <span class="string">""</span>,</span><br><span class="line">         info: <span class="string">""</span>,</span><br><span class="line">         html: <span class="string">""</span>,</span><br><span class="line">         btnConfirm: <span class="string">"Confirm"</span>,</span><br><span class="line">         btnCancel: <span class="string">"Cancel"</span>,</span><br><span class="line">         btnOk: <span class="string">"OK"</span>,</span><br><span class="line">         width: <span class="number">400</span>,</span><br><span class="line">         height: <span class="number">260</span>,</span><br><span class="line">         hotKey: <span class="literal">true</span>,</span><br><span class="line">         closeIcon: <span class="literal">true</span>,</span><br><span class="line">         cancel: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;,</span><br><span class="line">         ok: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;,</span><br><span class="line">         confirm: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;,</span><br><span class="line">         beforeInit: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;,</span><br><span class="line">         afterClose: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">     &#125;;</span><br><span class="line">&#125;)(jQuery);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>在使用select组件时，使用方式是现在html代码中写入原生态的select，然后后续封装的组件代码从页面中载入时自动根据原生态的select进行插件式select生成,换句话说，就是插件代码会在页面载入时对原生态的组件（例如select）打一个补丁，将原生态的组件隐藏，用户只会和我们封装定制好的组件交互。其中会进行一个双向绑定，操作封装组件会影响到原生态组件，代码操作原生态组件会反向影响封装的组件。controller中的监听事件均是在原生态的select上，这样就可以做到与封装的组件进行解耦，如果我们使用另外一个select插件，业务代码可以保持不变。</p>
<p>在使用封装select的时候遇到一个需求，即需要用户确认更改选择，该次select组件的change事件才生效，否则select原有值保持不变。封装select时产生的change事件传递如图：<br><img src="images/select-event-change-path.png" alt="select change event path"></p>
<p>用户看到的是selectWidget，那么当他触发change事件时，封装的selectWidget会触发原生态的select的change事件，业务逻辑得以执行。</p>
<p>值得一提的是，有一个特定的场景需要仔细思考设计一下：在业务逻辑中，有可能需要撤销selectWidget的change事件，也即是用户操作了selectWidget更换了它的值，但是也许这是一个非法操作（具体场景是用户在录制视频时切换分辨率的select，页面会提示是否确定中断录制视频，如果用户点击不中断的话，之前的selectWidget的change事件就是非法操作）需要撤销，将selectWidget的值恢复为原来的值。而此时controller的业务逻辑可以影响select（为了与selectWidget解耦），但是不能影响selectWidget（因为业务代码中不应该涉及到具体的封装，只涉及到原生态的select）。所以问题就是controller知道要恢复selectWidget的值，应该如何优雅的恢复。</p>
<p>解决方法是，在selectWidget触发change事件之前先触发beforeChange事件，这个事件可以决定是不是触发change(类似于window的onbeforeunload可以阻止unload事件一样)，事件驱动图如下：<br><img src="images/select-before-change.png" alt="select before change"></p>
<h4 id="基础库"><a href="#基础库" class="headerlink" title="基础库"></a>基础库</h4><ul>
<li><p>用于检测用户所使用的客户端浏览器类型与版本。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findBrowserTypeVersion</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> ua = navigator.userAgent,</span><br><span class="line">        tem,</span><br><span class="line">        M = ua.match(<span class="regexp">/(opera|chrome|safari|firefox|msie|edge|trident(?=\/))\/?\s*(\d+)/i</span>) || [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> ieVer = <span class="number">0</span>; ieVer &lt; <span class="number">12</span>; ieVer++) &#123;</span><br><span class="line">        <span class="keyword">var</span> b = <span class="built_in">document</span>.createElement(<span class="string">'b'</span>)</span><br><span class="line">        b.innerHTML = <span class="string">'&lt;!--[if IE '</span> + ieVer + <span class="string">']&gt;&lt;i&gt;&lt;/i&gt;&lt;![endif]--&gt;'</span>;</span><br><span class="line">        <span class="keyword">if</span> (b.getElementsByTagName(<span class="string">'i'</span>).length === <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"MSIE "</span> + ieVer;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (<span class="regexp">/trident/i</span>.test(M[<span class="number">1</span>])) &#123;</span><br><span class="line">        tem = <span class="regexp">/\brv[ :]+(\d+)/g</span>.exec(ua) || [];</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'MSIE '</span> + (tem[<span class="number">1</span>] || <span class="string">''</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (M[<span class="number">1</span>] === <span class="string">'Chrome'</span>) &#123;</span><br><span class="line">        tem = ua.match(<span class="regexp">/\bOPR\/(\d+)/</span>);</span><br><span class="line">        <span class="keyword">if</span> (tem != <span class="literal">null</span>) <span class="keyword">return</span> <span class="string">'Opera '</span> + tem[<span class="number">1</span>];</span><br><span class="line">        tem = ua.match(<span class="regexp">/Edge\/(\d+)/</span>);</span><br><span class="line">        <span class="keyword">if</span> (tem != <span class="literal">null</span>) <span class="keyword">return</span> <span class="string">'Edge '</span> + tem[<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    M = M[<span class="number">2</span>] ? [M[<span class="number">1</span>], M[<span class="number">2</span>]] : [navigator.appName, navigator.appVersion, <span class="string">'-?'</span>];</span><br><span class="line">    <span class="keyword">if</span> ((tem = ua.match(<span class="regexp">/version\/(\d+)/i</span>)) != <span class="literal">null</span>) M.splice(<span class="number">1</span>, <span class="number">1</span>, tem[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">return</span> M.join(<span class="string">' '</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>做跨域请求时IE8不能使用jQuery封装的ajax(xmlhttprequest)，只能使用xdr(xmldomainrequest)，所以需要做一个库能够提供接口兼容这两种不同的浏览器。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">$</span>) </span>&#123;</span><br><span class="line"><span class="meta">    "use strict"</span>;</span><br><span class="line"></span><br><span class="line">    $.ipc = $.ipc || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">ieXDomainAjax</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">window</span>.XDomainRequest == <span class="literal">undefined</span>) &#123;</span><br><span class="line">            <span class="built_in">console</span>.error(<span class="string">"no XDomainRequest in current browser"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> xdr = <span class="keyword">new</span> XDomainRequest();</span><br><span class="line">        <span class="keyword">if</span> (xdr == <span class="literal">undefined</span>) &#123;</span><br><span class="line">            <span class="built_in">console</span>.error(<span class="string">"can not create XDomainRequest instance"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> newOptions = $.extend(<span class="literal">true</span>, &#123;&#125;, $.xAjax.ieXDomainAjaxDefaults, options);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (newOptions.url == <span class="literal">undefined</span>) &#123;</span><br><span class="line">            <span class="built_in">console</span>.error(<span class="string">"no url in ieXDomainAjax"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        xdr.onerror = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            (options.error || <span class="function"><span class="keyword">function</span>(<span class="params">xdr</span>) </span>&#123;&#125;)(xdr);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        xdr.ontimeout = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            (options.error || <span class="function"><span class="keyword">function</span>(<span class="params">xdr</span>) </span>&#123;&#125;)(xdr);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        xdr.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> response = $.parseJSON(xdr.responseText);</span><br><span class="line">            (options.success || <span class="function"><span class="keyword">function</span>(<span class="params">resp</span>) </span>&#123;&#125;)(response);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        xdr.onprogress = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            (options.onprogress || <span class="function"><span class="keyword">function</span>(<span class="params">xdr</span>) </span>&#123;&#125;)(xdr);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (newOptions.contentType.indexOf(<span class="string">"x-www-form-urlencoded"</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            newOptions.data = $.param(newOptions.data);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        xdr.timeout = newOptions.timeout;</span><br><span class="line">        xdr.open(newOptions.type, newOptions.url);</span><br><span class="line">        xdr.send(newOptions.data);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">normalAjax</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> newOptions = $.extend(<span class="literal">true</span>, &#123;&#125;, $.xAjax.normalAjaxDefaults, options);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (newOptions.url == <span class="literal">undefined</span>) &#123;</span><br><span class="line">            <span class="built_in">console</span>.error(<span class="string">"options.url in undefined in normalAjax"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        newOptions.beforeSend = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            (options.beforeSend || <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;)();</span><br><span class="line">        &#125;</span><br><span class="line">        newOptions.complete = <span class="function"><span class="keyword">function</span>(<span class="params">xhr</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> ajaxContext = <span class="keyword">this</span>;</span><br><span class="line">            $.proxy((options.complete || <span class="function"><span class="keyword">function</span>(<span class="params">xhr</span>) </span>&#123;&#125;), ajaxContext)(xhr);</span><br><span class="line">        &#125;</span><br><span class="line">        newOptions.error = <span class="function"><span class="keyword">function</span>(<span class="params">xhr</span>) </span>&#123;</span><br><span class="line">            (options.error || <span class="function"><span class="keyword">function</span>(<span class="params">xhr</span>) </span>&#123;&#125;)(xhr);</span><br><span class="line">        &#125;</span><br><span class="line">        newOptions.success = <span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> ajaxContext = <span class="keyword">this</span>;</span><br><span class="line">            $.proxy((options.success || <span class="function"><span class="keyword">function</span>(<span class="params">resp</span>) </span>&#123;&#125;), ajaxContext)(response);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> ajaxObj = $.ajax(newOptions);</span><br><span class="line">        <span class="keyword">return</span> ajaxObj;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> browserAjaxMap = &#123;</span><br><span class="line">        <span class="string">"MSIE 8"</span>: ieXDomainAjax,</span><br><span class="line">        <span class="string">"MSIE 9"</span>: ieXDomainAjax,</span><br><span class="line">        <span class="string">"MSIE 10"</span>: ieXDomainAjax</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    $.xAjax = <span class="function"><span class="keyword">function</span>(<span class="params">options, xDomain</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> ajaxFunction = xDomainAjaxMap[xDomain] || normalAjax;</span><br><span class="line">        <span class="keyword">var</span> ajaxObj = ajaxFunction(options);</span><br><span class="line">        <span class="keyword">return</span> ajaxObj;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    $.xAjax.normalAjaxDefaults = &#123;</span><br><span class="line">        type: <span class="string">"post"</span>,</span><br><span class="line">        data: &#123;&#125;,</span><br><span class="line">        dataType: <span class="string">"json"</span>,</span><br><span class="line">        cache: <span class="literal">false</span>,</span><br><span class="line">        contentType: <span class="string">"application/json;charset=utf-8"</span>,</span><br><span class="line">        headers: &#123;</span><br><span class="line">            Accept: <span class="string">"application/json, */*; version=1.0; charset=utf-8;"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        timeout: <span class="number">60000</span>,</span><br><span class="line">        <span class="keyword">async</span>: <span class="literal">true</span>,</span><br><span class="line">        global: <span class="literal">false</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    $.xAjax.ieXDomainAjaxDefaults = &#123;</span><br><span class="line">        timeout: <span class="number">60000</span>,</span><br><span class="line">        type: <span class="string">"post"</span>,</span><br><span class="line">        data: &#123;&#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    $.xAjax.defaults = &#123;</span><br><span class="line">        xType: <span class="string">"xDomain"</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> xDomainStr = $.xAjax.defaults.xType;</span><br><span class="line">    <span class="keyword">var</span> xDomainAjaxMap = &#123;&#125;;</span><br><span class="line">    xDomainAjaxMap[xDomainStr] = browserAjaxMap[$.ipc.Browser.prototype.type + <span class="string">' '</span> + $.ipc.Browser.prototype.version] || normalAjax;</span><br><span class="line">&#125;)(jQuery);</span><br></pre></td></tr></table></figure>
</li>
<li><p>字符串版本比较。部分需求需要针对字符串类型的版本号进行比较大小。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">$.ipc.compareVersion = <span class="function"><span class="keyword">function</span> <span class="title">versionCompare</span>(<span class="params">v1, v2, options</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> defaultOptions = &#123;</span><br><span class="line">        lexicographical: <span class="literal">false</span>,</span><br><span class="line">        zeroExtend: <span class="literal">true</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">var</span> _options = $.extend(<span class="literal">true</span>, defaultOptions, options);</span><br><span class="line">    <span class="keyword">var</span> lexicographical = _options &amp;&amp; _options.lexicographical,</span><br><span class="line">        zeroExtend = _options &amp;&amp; _options.zeroExtend,</span><br><span class="line">        v1parts = v1.split(<span class="string">'.'</span>),</span><br><span class="line">        v2parts = v2.split(<span class="string">'.'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">isValidPart</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (lexicographical ? <span class="regexp">/^\d+[A-Za-z]*$/</span> : <span class="regexp">/^\d+$/</span>).test(x);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!v1parts.every(isValidPart) || !v2parts.every(isValidPart)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NaN</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (zeroExtend) &#123;</span><br><span class="line">        <span class="keyword">while</span> (v1parts.length &lt; v2parts.length) v1parts.push(<span class="string">"0"</span>);</span><br><span class="line">        <span class="keyword">while</span> (v2parts.length &lt; v1parts.length) v2parts.push(<span class="string">"0"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!lexicographical) &#123;</span><br><span class="line">        v1parts = v1parts.map(<span class="built_in">Number</span>);</span><br><span class="line">        v2parts = v2parts.map(<span class="built_in">Number</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; v1parts.length; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (v2parts.length == i) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (v1parts[i] == v2parts[i]) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (v1parts[i] &gt; v2parts[i]) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (v1parts.length != v2parts.length) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ipc-web/">ipc-web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/front-end/">前端</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/refactor/">重构</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/javascript/">javascript</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-ipc-web重构 (五) 构建工具" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/21/ipc-web重构 (五) 构建工具/" class="article-date">
  	<time datetime="2016-04-21T09:49:01.000Z" itemprop="datePublished">2016-04-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/21/ipc-web重构 (五) 构建工具/">ipc-web重构 (五) 构建工具</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><br>介绍完前端重构的MVC框架之后有必要介绍一下，针对性能优化我们能够使用的一些离线工具。本项目采用的是<a href="http://fis.baidu.com/" target="_blank" rel="external">FIS3</a>。<br>Fis3主要功能基本都是围绕着前端开发所需要的三种编译能力：资源定位、内容嵌入、依赖声明。如何使用这些能力，配置文件相当重要。我们可以在配置文件中：</p>
<ol>
<li>定义发布的规则，源文件路径可以与发布路径不一致。</li>
<li>制定文件指纹，压缩资源等优化方式。</li>
<li>配置不同版本的发布(build, alpha, beta, product)。</li>
<li>自定义插件，可以在发布的过程中实现特定的需求。</li>
</ol>
<p>在本项目中使用到了以下特性：</p>
<ol>
<li><p>文件指纹。文件指纹在缓存利用中相当有用。它的做法是在文件名中加入文件内容的一个hash值，这样如果内容改变，那么文件名称也会改变。那么发布时旧代码依赖的旧文件不会改变，新代码依赖的新文件，不会依赖旧文件。配置项如下:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fis.media(<span class="string">'build'</span>).match(<span class="string">'*.&#123;js,css,png,ico&#125;'</span>, &#123;</span><br><span class="line">       useHash: <span class="literal">true</span></span><br><span class="line">   &#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>压缩优化等。可以对css，js进行精简化，可以对图片文件使用压缩工具进行压缩，配置如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">fis.media(<span class="string">'build'</span>).match(<span class="string">'*.js'</span>, &#123;</span><br><span class="line">    optimizer: fis.plugin(<span class="string">'uglify-js'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">.match(<span class="string">'*.css'</span>, &#123;</span><br><span class="line">    optimizer: fis.plugin(<span class="string">'clean-css'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">.match(<span class="string">'*.png'</span>, &#123;</span><br><span class="line">    optimizer: fis.plugin(<span class="string">'png-compressor'</span>)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>定义发布不同的版本。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">fis.media(<span class="string">'alpha'</span>)</span><br><span class="line">   .match(<span class="string">'*.&#123;js,css,png,ico&#125;'</span>, &#123;</span><br><span class="line">       domain: ALPHA_CDN_PATH</span><br><span class="line">   &#125;)</span><br><span class="line">   .match(<span class="string">'*'</span>, &#123;</span><br><span class="line">       release: <span class="string">'/$0'</span></span><br><span class="line">   &#125;)</span><br><span class="line">   .match(<span class="string">'fis-conf.js'</span>, &#123;</span><br><span class="line">       release: <span class="literal">false</span></span><br><span class="line">   &#125;);</span><br><span class="line"></span><br><span class="line">fis.media(<span class="string">'beta'</span>)</span><br><span class="line">   .match(<span class="string">'*.&#123;js,css,png,ico&#125;'</span>, &#123;</span><br><span class="line">       domain: BETA_CDN_PATH</span><br><span class="line">   &#125;)</span><br><span class="line">   .match(<span class="string">'*'</span>, &#123;</span><br><span class="line">       release: <span class="string">'/$0'</span></span><br><span class="line">   &#125;)</span><br><span class="line">   .match(<span class="string">'fis-conf.js'</span>, &#123;</span><br><span class="line">       release: <span class="literal">false</span></span><br><span class="line">   &#125;);</span><br><span class="line"></span><br><span class="line">fis.media(<span class="string">'product'</span>)</span><br><span class="line">   .match(<span class="string">'*.&#123;js,css,png,ico&#125;'</span>, &#123;</span><br><span class="line">       domain: PRODUCT_CDN_PATH</span><br><span class="line">   &#125;)</span><br><span class="line">   .match(<span class="string">'*'</span>, &#123;</span><br><span class="line">       release: <span class="string">'/$0'</span></span><br><span class="line">   &#125;)</span><br><span class="line">   .match(<span class="string">'fis-conf.js'</span>, &#123;</span><br><span class="line">       release: <span class="literal">false</span></span><br><span class="line">   &#125;);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>除此之外，依据需求在此基础上开发了两个插件：前端html代码的组件化，和实现a标签href属性以及img标签的data-url属性的资源定位的插件。</p>
<h4 id="html代码的组件化。"><a href="#html代码的组件化。" class="headerlink" title="html代码的组件化。"></a>html代码的组件化。</h4><p>在开发的时候，总是会面对html代码中需要重复的使用header块和foot块。这样的重复代码不易维护，不便于管理，所以需要找到一个机制能够将这些公共部分抽离出来，等到发布的时候再补上公共部分。类似于jinja2(python)的模板继承。<br>例如a.html内容如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends "../../common/base.html" %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block title %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">title</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span>Admin<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<p>而基类模板内容如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=utf-8"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"description"</span> <span class="attr">content</span>=<span class="string">"cloud tp-link"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"IE=edge"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">&#123;% block title %&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<p>那么extends出来a.html内容就变成：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Type"</span> <span class="attr">content</span>=<span class="string">"text/html; charset=utf-8"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"description"</span> <span class="attr">content</span>=<span class="string">"cloud tp-link"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"IE=edge"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span>Admin<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>核心代码templateInherit如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> templateInherit = <span class="function"><span class="keyword">function</span>(<span class="params">childFile, baseFile</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// body...</span></span><br><span class="line">    <span class="keyword">var</span> childTagArr = getTagArrKeyValue(childFile);</span><br><span class="line">    <span class="keyword">var</span> baseTagArr = getTagArrKeyValue(baseFile);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> baseContent = baseFile.getContent();</span><br><span class="line">    <span class="keyword">var</span> childContent = childFile.getContent();</span><br><span class="line">    <span class="keyword">var</span> lastAddedLength = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> block <span class="keyword">in</span> baseTagArr[<span class="string">'block'</span>]) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; baseTagArr[<span class="string">'block'</span>][block].length; i++) &#123;</span><br><span class="line">            baseTagArr[<span class="string">'block'</span>][block][i] += lastAddedLength;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> preContent = baseContent.substring(<span class="number">0</span>, baseTagArr[<span class="string">'block'</span>][block][<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">var</span> lastContent = baseContent.substring(baseTagArr[<span class="string">'block'</span>][block][<span class="number">3</span>] + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">var</span> currentBaseBlockLength = baseTagArr[<span class="string">'block'</span>][block][<span class="number">3</span>] - </span><br><span class="line">            baseTagArr[<span class="string">'block'</span>][block][<span class="number">0</span>] + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> addedContent;</span><br><span class="line">        <span class="keyword">if</span> (childTagArr[<span class="string">'block'</span>][block] != <span class="literal">undefined</span>) &#123;</span><br><span class="line">            addedContent = childContent.substring(childTagArr[<span class="string">'block'</span>][block][<span class="number">1</span>] + <span class="number">1</span>, </span><br><span class="line">                childTagArr[<span class="string">'block'</span>][block][<span class="number">2</span>]);</span><br><span class="line">            <span class="keyword">delete</span> childTagArr[<span class="string">'block'</span>][block];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            addedContent = <span class="string">""</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// refresh offset when render child content to base content</span></span><br><span class="line">        lastAddedLength += addedContent.length - currentBaseBlockLength;</span><br><span class="line">        baseContent = preContent + addedContent + lastContent;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> block <span class="keyword">in</span> childTagArr[<span class="string">'block'</span>]) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="string">"child has some block which base doesn't have: "</span> + block + <span class="string">";"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> baseContent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后在fis编译期间注册我们写的插件：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fis.config.set(<span class="string">'modules.postpackager'</span>, [myResourceLocate, templateInheritance]);</span><br></pre></td></tr></table></figure>
<h4 id="特定属性的资源定位。"><a href="#特定属性的资源定位。" class="headerlink" title="特定属性的资源定位。"></a>特定属性的资源定位。</h4><p>在fis中定位资源的方式有限，可以在html的静态资源节点中定位，css和js中定位，但是特定条件的定位，例如要定位a标签的href属性，它是不支持的。但是我们可以手动写一个插件来定位html代码中我们需要的属性, 核心代码replaceResourceLocation如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> replaceResourceLocation = <span class="function"><span class="keyword">function</span>(<span class="params">fileSrc, file</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (file) &#123;</span><br><span class="line">        <span class="keyword">var</span> content = file.getContent();</span><br><span class="line">        <span class="keyword">var</span> fileDir = file.dirname;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> aHrefPattern = <span class="regexp">/(&lt;a.*?)href=(['"]?)([^'"\s?]+)((\?[^'"\s]*)?)\2([^&gt;]*&gt;)/ig</span>;</span><br><span class="line">        <span class="keyword">var</span> afterReplaceAHrefContent = content.replace(aHrefPattern, <span class="function"><span class="keyword">function</span>(<span class="params">all, prefix, quote, value, query, queryInner, postfix</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> f = fis.uri(value, fileDir);</span><br><span class="line">            <span class="keyword">if</span> (f.file) &#123;</span><br><span class="line">                <span class="keyword">var</span> releasePath = fileSrc[<span class="string">"/"</span> + f.file.id].getHashRelease();</span><br><span class="line">                all = prefix + <span class="string">'href='</span> + quote + releasePath + query + quote + postfix;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> all;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> dateUrlPattern = <span class="regexp">/(&lt;img.*?)data-url=(['"]?)([^'"\s?]+)((\?[^'"\s]*)?)\2([^&gt;]*&gt;)/ig</span>;</span><br><span class="line">        <span class="keyword">var</span> dataUrlLocateContent = afterReplaceAHrefContent.replace(dateUrlPattern, <span class="function"><span class="keyword">function</span>(<span class="params">all, prefix, quote, value, query, queryInner, postfix</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> f = fis.uri(value, fileDir);</span><br><span class="line">            <span class="keyword">if</span> (f.file) &#123;</span><br><span class="line">                <span class="keyword">var</span> releasePath = fileSrc[<span class="string">"/"</span> + f.file.id].getHashRelease();</span><br><span class="line">                all = prefix + <span class="string">'data-url='</span> + quote + releasePath + query + quote + postfix;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> all;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> dataUrlLocateContent;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注册插件代码请见上一节中html代码组件化的注册截图。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ipc-web/">ipc-web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/front-end/">前端</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/refactor/">重构</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/javascript/">javascript</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-ipc-web重构 (四) 我的MVC" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/21/ipc-web重构 (四) 我的MVC/" class="article-date">
  	<time datetime="2016-04-21T07:45:26.000Z" itemprop="datePublished">2016-04-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/21/ipc-web重构 (四) 我的MVC/">ipc-web重构 (四) 我的MVC</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><br>前端的业务日益复杂，在面向对象编程的基础上需要一个良好的架构来管理和组织各个不同的模块，进行分工协作，完成复杂的任务。</p>
<p>而MVC模式就是一个良好的解决方案。它区分了模型，表现，以及响应用户输入的三个不同的类：</p>
<ul>
<li>Model用于管理数据的行为，传递数据模型的状态给view，以及更改数据模型的状态。</li>
<li>View用于展现model的各种信息。</li>
<li>Controller用于接收用户事件，然后通知model和view进行改变。</li>
</ul>
<p>经典的MVC模型如下：</p>
<p><img src="images/classic-mvc.png" alt="classic mvc"></p>
<p>在经典MVC模型基础上有两个变种：</p>
<ul>
<li><p>被动式MVC，流程图如图：<br><img src="images/passive-mvc.png" alt="passive mvc"><br>Controller响应事件，通知model更改状态，然后通知view去更新显示。在这种模式中Model完全独立于controller和view，所以它自己更新状态的时候无法通知到其他模块。</p>
</li>
<li><p>主动式MVC，如图：<br><img src="images/active-mvc.png" alt="active mvc"><br>使用Observer的接口来对model和view进行解耦。那么model通知view的方式如下:<br><img src="images/notify.png" alt="notify viewer"></p>
</li>
</ul>
<h4 id="我的MVC"><a href="#我的MVC" class="headerlink" title="我的MVC"></a>我的MVC</h4><p>开始设计前端重构的时候，是想基于MV * 方式进行，提议使用开源的框架例如backbone，angular等进行重构，但是因为以下原因而被否决：</p>
<ol>
<li>使用开源框架有学习摸索的成本，所以在时间管理上不符合预期。</li>
<li>使用开源框架来重构会改动太大，毕竟如果使用angular，完全颠覆了jquery，所以会有较大的风险。</li>
<li>开发门槛高，不利于任务继承与分配。</li>
</ol>
<p>于是最终的结果是先参照普适用的MVC模式进行优化，成熟之后再考虑转为angularJS。被动式MVC太过于简单，不适用于我们目前比较复杂的前端场景。于是我们需要主动式MVC来进行前端的重构。</p>
<p>设计出来的各个模块如图：<br><img src="images/my-mvc.png" alt="my mvc"><br>其中View用于不同类型的展示。Model用于保存数据状态，Controller抉择该使用何种view。特别地：我们将ajax异步获取数据状态的业务放置在Model中。这样做的好处是能够在不同的页面内使用相同的model，然后可以复用该异步更新状态的业务。</p>
<h4 id="代码片段"><a href="#代码片段" class="headerlink" title="代码片段"></a>代码片段</h4><ul>
<li><p>Model<br>Model类，在该基类中封装了两个方法，一个是异步获取数据更新自身状态的方法，一个是封装的validate成员属性类。  </p>
<ul>
<li><p>makeAjaxRequest方法  </p>
<pre><code class="javascript">Model.prototype.makeAjaxRequest = <span class="function"><span class="keyword">function</span>(<span class="params">inputArgs, xDomain</span>) </span>{

    <span class="keyword">if</span> (<span class="literal">undefined</span> == inputArgs[<span class="string">"url"</span>] || <span class="literal">undefined</span> == inputArgs[<span class="string">"data"</span>] || 
        <span class="literal">undefined</span> == inputArgs[<span class="string">"changeState"</span>]) {
        <span class="built_in">console</span>.error(<span class="string">"args error in makeAjaxRequest"</span>);
        <span class="keyword">return</span>;
    };

    <span class="keyword">var</span> tmpCallbacks = <span class="keyword">this</span>.extendErrorCodeCallback(inputArgs[<span class="string">"callbacks"</span>]);
    <span class="keyword">var</span> currentModel = <span class="keyword">this</span>;

    <span class="keyword">var</span> ajaxOptions = {
        url: inputArgs[<span class="string">"url"</span>],
        data: inputArgs[<span class="string">"data"</span>],
        success: <span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>{
            <span class="keyword">var</span> errCodeStrIndex = inputArgs[<span class="string">"errCodeStrIndex"</span>] || <span class="string">"errorCode"</span>;
            <span class="keyword">var</span> noErrorCode = inputArgs[<span class="string">"noErrorCode"</span>] || <span class="number">0</span>;
            <span class="keyword">var</span> defaultErrorCode = inputArgs[<span class="string">"defaultErrorCode"</span>] || <span class="number">-1</span>;

            <span class="keyword">if</span> (response[errCodeStrIndex] == noErrorCode) {
                <span class="keyword">var</span> changeStateFunc = $.proxy(inputArgs[<span class="string">"changeState"</span>], currentModel);
                changeStateFunc(response);
            }
            <span class="keyword">var</span> callbackFunc = tmpCallbacks.errorCodeCallbackMap[response[errCodeStrIndex]] || 
                tmpCallbacks.errorCodeCallbackMap[defaultErrorCode];
            callbackFunc(response);
            <span class="keyword">if</span> (tmpCallbacks.commonCallback) {
                tmpCallbacks.commonCallback();
            };
        },
        error: <span class="function"><span class="keyword">function</span>(<span class="params">xhr</span>) </span>{
            tmpCallbacks.errorCallback(xhr);
            <span class="keyword">if</span> (tmpCallbacks.commonCallback) {
                tmpCallbacks.commonCallback();
            };
        }
    };

    $.extend(<span class="literal">true</span>, ajaxOptions, inputArgs[<span class="string">"extendAjaxOptions"</span>]);

    <span class="keyword">return</span> $.xAjax(ajaxOptions, xDomain);
};
</code></pre>
</li>
<li>validate方法  <pre><code class="javascript">Model.prototype.validateAttr = <span class="function"><span class="keyword">function</span>(<span class="params">inputArgs</span>) </span>{
    <span class="keyword">if</span> (<span class="literal">undefined</span> == inputArgs[<span class="string">"attr"</span>] || <span class="literal">undefined</span> == inputArgs[<span class="string">"attrEmptyMsg"</span>] ||
        <span class="literal">undefined</span> == inputArgs[<span class="string">"maxLength"</span>] || <span class="literal">undefined</span> == inputArgs[<span class="string">"minLength"</span>] ||
        <span class="literal">undefined</span> == inputArgs[<span class="string">"attrOutOfLimitMsg"</span>] || <span class="literal">undefined</span> == inputArgs[<span class="string">"pattern"</span>] ||
        <span class="literal">undefined</span> == inputArgs[<span class="string">"patternTestFailMsg"</span>]) {
        <span class="built_in">console</span>.error(<span class="string">"args error in validateAttr"</span>);
        <span class="keyword">return</span>;
    };
    <span class="keyword">var</span> e = <span class="keyword">new</span> $.ipc.Error();
    <span class="keyword">if</span> (<span class="number">0</span> == inputArgs[<span class="string">"attr"</span>].length) {
        e.code = <span class="literal">false</span>;
        e.msg = inputArgs[<span class="string">"attrEmptyMsg"</span>];
    } <span class="keyword">else</span> <span class="keyword">if</span> (inputArgs[<span class="string">"attr"</span>].length &gt; inputArgs[<span class="string">"maxLength"</span>] || 
        inputArgs[<span class="string">"attr"</span>].length &lt; inputArgs[<span class="string">"minLength"</span>]) {
        e.code = <span class="literal">false</span>;
        e.msg = inputArgs[<span class="string">"attrOutOfLimitMsg"</span>];
    } <span class="keyword">else</span> <span class="keyword">if</span> (!inputArgs[<span class="string">"pattern"</span>].test(inputArgs[<span class="string">"attr"</span>])) {
        e.code = <span class="literal">false</span>;
        e.msg = inputArgs[<span class="string">"patternTestFailMsg"</span>];
    } <span class="keyword">else</span> {
        e.code = <span class="literal">true</span>;
        e.msg = <span class="string">"OK"</span>;
    };
    <span class="keyword">return</span> e;
};
</code></pre>
</li>
</ul>
</li>
<li><p>Controller<br>Controller类：内部封装两个方法，一个是addHandler接口，用于绑定DOM事件，通常外部不需要调用。  </p>
<ul>
<li><p>addHandler方法 (注意：这个方法仅在类内部使用)  </p>
<pre><code class="javascript">BaseController.prototype.addHandler = <span class="function"><span class="keyword">function</span>(<span class="params">inputArgs</span>) </span>{
    <span class="keyword">var</span> currentController = <span class="keyword">this</span>;
    <span class="keyword">var</span> getMsgInformed = inputArgs[<span class="string">"getMsgInformed"</span>];
    <span class="keyword">var</span> selector = inputArgs[<span class="string">"selector"</span>];
    <span class="keyword">var</span> eventName = inputArgs[<span class="string">"eventName"</span>];

    $(<span class="built_in">document</span>).on(eventName, selector, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
        <span class="keyword">var</span> data = <span class="literal">null</span>;
        <span class="keyword">if</span> (getMsgInformed) {
            data = $.proxy(getMsgInformed, <span class="keyword">this</span>)();
        };
        <span class="keyword">var</span> argumentsArr = <span class="built_in">arguments</span>;
        currentController.domClickCallbacks.fire(selector, eventName, data, argumentsArr);
    });
};
</code></pre>
</li>
<li><p>batchInitHandler。供外部使用的绑定事件的接口。  </p>
<pre><code class="javascript">BaseController.prototype.batchInitHandler = <span class="function"><span class="keyword">function</span>(<span class="params">appendedSelectorHandlerMap, 
selectorMsgProduceFuncMap</span>) </span>{
    <span class="keyword">if</span> (<span class="literal">undefined</span> == appendedSelectorHandlerMap ||
        <span class="literal">undefined</span> == selectorMsgProduceFuncMap) {
        <span class="built_in">console</span>.error(<span class="string">"args error in batchInitHandler"</span>);
    };

    $.extend(<span class="literal">true</span>, <span class="keyword">this</span>.selectorHandlerMap, appendedSelectorHandlerMap);

    <span class="keyword">for</span> (<span class="keyword">var</span> selector <span class="keyword">in</span> appendedSelectorHandlerMap) {
        <span class="keyword">var</span> args = {};
        args[<span class="string">"selector"</span>] = selector;
        args[<span class="string">"getMsgInformed"</span>] = selectorMsgProduceFuncMap[selector];
        <span class="keyword">for</span> (<span class="keyword">var</span> eventName <span class="keyword">in</span> appendedSelectorHandlerMap[selector]) {
            args[<span class="string">"eventName"</span>] = eventName;
            <span class="keyword">this</span>.addHandler(args);
        };
    };
};
</code></pre>
<p>使用用例如下：  </p>
<pre><code class="javascript">SoftwareController.prototype.initHandler = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
    <span class="keyword">var</span> appendedSelectorHandlerMap = {
        <span class="string">"#ipc-arrow-left"</span>: {
            <span class="string">"click"</span>: <span class="keyword">this</span>.turnMenuLeft
        },
        <span class="string">"#ipc-arrow-right"</span>: {
            <span class="string">"click"</span>: <span class="keyword">this</span>.turnMenuRight
        },
        <span class="string">".download-menu-cell"</span>: {
            <span class="string">"click"</span>: <span class="keyword">this</span>.gotoFaq
        }
    };

    <span class="keyword">var</span> selectorMsgProduceFuncMap = {
        <span class="string">".download-menu-cell"</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
            <span class="keyword">return</span> $(<span class="keyword">this</span>).attr(<span class="string">"faq-path"</span>);
        }
    };
    <span class="keyword">this</span>.batchInitHandler(appendedSelectorHandlerMap, selectorMsgProduceFuncMap);
};
</code></pre>
</li>
</ul>
<p>这样页面就监听了$(“#ipc-arrow-left”)元素上的click事件，并使用turnMenuLeft进行响应。</p>
</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ipc-web/">ipc-web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/front-end/">前端</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/refactor/">重构</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/javascript/">javascript</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-ipc-web重构 (三) 潮流前线" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/21/ipc-web重构 (三) 潮流前线/" class="article-date">
  	<time datetime="2016-04-21T06:31:41.000Z" itemprop="datePublished">2016-04-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/21/ipc-web重构 (三) 潮流前线/">ipc-web重构 (三) 潮流前线</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><br>上一章中提出了当前ipc-web的优化的方向。在这些优化上有很多前人已经开发了相当多的工具来提供给我们使用。本章就介绍一下一些已有的实现前端优化的资源。</p>
<h4 id="不只是性能优化"><a href="#不只是性能优化" class="headerlink" title="不只是性能优化"></a>不只是性能优化</h4><p>对于构建大型web应用的团队来说，要坚持贯彻雅虎的14条优化原则并不是一件十分容易的事。因为优化原则中很多要求是与工程管理相违背的，比如 把css放在头部 和 把js放在尾部 这两条原则，我们不能让团队的工程师在写样式和脚本引用的时候都去修改一个相同的页面文件。这样做会严重影响团队成员间并行开发的效率，尤其是在团队有版本管理的情况下，每天要花大量的时间进行代码修改合并，这项成本是难以接受的。所以性能优化是一个工程问题。于是就有了前端集成解决方案，即将前端研发领域中各种分散的技术元素集中在一起，并对常见的前端开发问题、不足、缺陷和需求，所提出的一种解决问题的方案。现有的一些构建工具有：</p>
<ul>
<li>Fis3: 解决前端工程中性能优化、资源加载（异步、同步、按需、预加载、依赖管理、合并、内嵌）、模块化开发、自动化工具、开发规范、代码部署等问题。由百度开发提供。</li>
<li>seajs开发体系，支付宝团队前端开发体系，以 spm 为构建和包管理工具。</li>
<li>fis-plus，百度绝大多数前端团队使用的开发体系，以fis为构建工具内核，以lights为包管理工具。</li>
<li>edp，百度ecomfe前端开发体系，以 edp 为构建和包管理工具。</li>
<li>modjs，腾讯AlloyTeam团队出品的开发体系。</li>
<li>yeoman，google出品的解决方案，以grunt为构建工具，bower为包管理工具。</li>
</ul>
<h4 id="前端MV-框架"><a href="#前端MV-框架" class="headerlink" title="前端MV * 框架"></a>前端MV * 框架</h4><p>针对前端代码架构上，可以采用一些流行的MV <em> 模式来进行，对MV </em> 不了解的可以访问以下网址<a href="https://msdn.microsoft.com/en-us/library/ff649643.aspx" target="_blank" rel="external">1</a>和<a href="https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller" target="_blank" rel="external">2</a>。如下：</p>
<ul>
<li>BackboneJS<br>Backbone通过提供模型Model、集合Collection、视图View赋予了Web应用程序分层结构，其中模型包含领域数据和自定义事件；集合Colection是模型的有序或无序集合，带有丰富的可枚举API；视图可以声明事件处理函数。最终将模型、集合、视图与服务端的RESTful JSON接口连接。<br>Backbone在升级的过程中，去掉了controller，由view和router代替controller，view集中处理了用户事件（如click，keypress等）、渲染HTML模板、与模型数据的交互。Backbone的model没有与UI视图数据绑定，而是需要在view中自行操作DOM来更新或读取UI数据。Router为客户端路由提供了许多方法，并能连接到指定的动作（actions）和事件（events）。<br>Backbone是一个小巧灵活的库，只是帮你实现一个MVC模式的框架，更多的还需要自己去实现。适合有一定Web基础，喜欢原生JS去操作DOM（因为没有数据绑定）的开发人员。为什么称它为库，而不是框架，不仅仅是由于仅4KB的代码，更重要的是使用一个库，你有控制权。如果用一个框架，控制权就反转了，变成框架在控制你。库能够给予灵活和自由，但是框架强制使用某种方式，减少重复代码。这便是Backbone与Angular的区别之一了。<br>至于Backbone属于MV * 中的哪种模式，有人认为不是MVC，有人觉得更接近于MVP，事实上，它借用多个架构模式中一些很好的概念，创建一个运行良好的灵活框架。不必拘泥于某种模式。</li>
<li>KnockoutJS<br>KnockoutJS是一个名正言顺的MVVM框架，通过简洁易读的data-bind语法，将DOM元素与viewmodel关联起来。当模型（viewmodel）状态更新时，自动更新UI界面。 viewmodel是model和view上的操作的一个连接，是一个纯粹的Javascript对象。它不是UI，没有控件和样式的概念，它也不是持久化的模型数据，它只是hold住一些用户正在编辑的数据，然后暴露出操作这些数据（增加或删除）的方法。<br>view是对viewmodel中数据的一个可视化的显示，view观察viewmodel，操作view时会发送命令到viewmodel，并且当viewmodel变化时更新。view和model是不了解彼此的存在的。</li>
<li>AngularJS<br>AngularJS试图成为Web应用中的一种端对端的解决方案。这意味着它不只是你的Web应用中的一个小部分，而是一个完整的端对端的解决方案。这会让AngularJS在构建一个CRUD的应用时看起来很呆板，缺乏灵活性。AngularJS是为了克服HTML在构建应用上的不足而设计的。使用了不同的方法，它尝试去补足HTML本身在构建应用方面的缺陷。通过使用标识符(directives)的结构，让浏览器能够识别新的语法。例如使用双大括号语法进行数据绑定；使用ng-controller指定每个控制器负责监视视图中的哪一部分；使用ng-model，把输入数据绑定到模型中的一部分属性上。<br>双向数据绑定是AngularJS的另一个特性。UI控件的任何更改会立即反映到模型变量（一个方向），模型变量的任何更改都会立即反映到问候语文本中（另一方向）。AngularJS通过作用域来保持数据模型与视图界面UI的双向同步。一旦模型状态发生改变，AngularJS会立即刷新反映在视图界面中，反之亦然。<br>AngularJS原本是倾向于MVC，但是随着项目重构和版本升级，现在更接近MVVM。和Knockout view中的风格类似，都像从WPF衍变过来的，只是Knockout使用了自定义属性data-bind作为绑定入口，而AngularJS对于HTML的变革更彻底，扩展HTML的语法，引入一系列的指令。<br>在AngularJS中，一个视图是模型通过HTML模板渲染之后的映射。这意味着，不论模型什么时候发生变化，AngularJS会实时更新结合点，随之更新视图。</li>
</ul>
<p>对于MV <em> 家族，都是在经典MVC基础上随着时代的发展、应用环境的变化衍变出来的。实现MV </em> 模式的这些框架到底归属于哪种模式，也不必泥古。MV <em> 是一个很有争议性的话题，能够构建一个健壮、具有良好设计、遵从关注点分离的项目比花时间去争论到底是MV </em> 更有意义<a href="http://efe.baidu.com/blog/mvc-deformation/" target="_blank" rel="external">3</a>。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ipc-web/">ipc-web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/front-end/">前端</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/refactor/">重构</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/javascript/">javascript</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-ipc-web重构 (二) 优化方向" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/21/ipc-web重构 (二) 优化方向/" class="article-date">
  	<time datetime="2016-04-21T04:02:41.000Z" itemprop="datePublished">2016-04-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/21/ipc-web重构 (二) 优化方向/">ipc-web重构 (二) 优化方向</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><br>Ipc-web重构优化可以分为两种优化，性能优化与代码优化。</p>
<h4 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h4><p>雅虎的14条性能优化的<a href="https://developer.yahoo.com/performance/rules.html" target="_blank" rel="external">原则</a>，还有一些经典的<a href="https://www.google.co.jp/search?q=%E9%AB%98%E6%80%A7%E8%83%BD%E7%BD%91%E7%AB%99%E5%BB%BA%E8%AE%BE%E6%8C%87%E5%8D%97&amp;oq=%E9%AB%98%E6%80%A7%E8%83%BD%E7%BD%91%E7%AB%99%E5%BB%BA%E8%AE%BE%E6%8C%87%E5%8D%97&amp;aqs=chrome..69i57.306j0j7&amp;sourceid=chrome&amp;es_sm=93&amp;ie=UTF-8" target="_blank" rel="external">指导书</a>，来进行优化。根据<a href="https://github.com/fouber/blog/issues/3" target="_blank" rel="external">资源</a>性能优化原则可以梳理分类为以下方向：</p>
<table>
<thead>
<tr>
<th>优化方向</th>
<th style="text-align:left">优化手段</th>
</tr>
</thead>
<tbody>
<tr>
<td>请求数量</td>
<td style="text-align:left">合并脚本和样式表，CSS Sprites，拆分初始化负载，划分主域</td>
</tr>
<tr>
<td>请求带宽</td>
<td style="text-align:left">开启GZip，精简JavaScript，移除重复脚本，图像优化</td>
</tr>
<tr>
<td>缓存利用</td>
<td style="text-align:left">使用CDN，使用外部JavaScript和CSS，添加Expires头，减少DNS查找，配置ETag，使AjaX可缓存</td>
</tr>
<tr>
<td>页面结构</td>
<td style="text-align:left">将样式表放在顶部，将脚本放在底部，尽早刷新文档的输出</td>
</tr>
<tr>
<td>代码校验</td>
<td style="text-align:left">避免CSS表达式，避免重定向</td>
</tr>
</tbody>
</table>
<p>我们可以针对不同的性能优化方向使用不同的工具来达到性能优化。例如：</p>
<ul>
<li>请求数量。 <ul>
<li>我们可以使用requirejs来实现按需加载，当模块不需要的时候不引用该模块代码。</li>
<li>可以离线将css或者图像做成内联的来减少请求数量。</li>
</ul>
</li>
<li>请求带宽。<ul>
<li>可以在服务器端开启静态资源的GZIP压缩。</li>
<li>利用 yui compressor 或者 google closure compiler 等压缩工具对js代码进行精简化。</li>
</ul>
</li>
<li>缓存利用。<ul>
<li>添加Expires头，配置ETag，使Ajax可缓存。</li>
<li>使用CDN。</li>
</ul>
</li>
<li>页面结构。<ul>
<li>可以在代码中控制CSS尽量放在顶部，JS在底部，尽早刷新文档。</li>
</ul>
</li>
</ul>
<p>优化完成之后可以在<a href="https://developers.google.com/speed/pagespeed/insights/?url=ALPHA.TPLINKCLOUD.COM&amp;tab=desktop" target="_blank" rel="external">这个</a>网址中进行测试。</p>
<h4 id="代码优化"><a href="#代码优化" class="headerlink" title="代码优化"></a>代码优化</h4><p>针对已有ipc-web代码的一些缺点，可以有以下优化方向：</p>
<ol>
<li>从面向过程进展为面向对象。面向对象编程可以较大的提高代码的可复用性，可拓展性。</li>
<li>使用MVC模式架构来编写。前端业务日益复杂，需要一个良好的架构来管理驱动各个模块。</li>
<li>制定html, js, css的各种基本规范。</li>
<li>使用开源资源来管理优化前端代码的构建。</li>
</ol>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ipc-web/">ipc-web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/front-end/">前端</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/refactor/">重构</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/javascript/">javascript</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
    <article id="post-ipc-web重构 (一) 背景" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/21/ipc-web重构 (一) 背景/" class="article-date">
  	<time datetime="2016-04-21T02:02:41.000Z" itemprop="datePublished">2016-04-21</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/21/ipc-web重构 (一) 背景/">ipc-web重构 (一) 背景</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><br>随着网络的普及，以及终端硬件性能和带宽的提升，物联网的智能设备得以普及。<em>IPCAMERA</em>就是我司物联网智能设备的先驱者，早在13年就开始进行设计和研发，14年正式上线。</p>
<h4 id="Ipcweb"><a href="#Ipcweb" class="headerlink" title="Ipcweb"></a>Ipcweb</h4><p>Ipcweb是指为产品<em>IPCAMERA</em>开发维护的提供云服务的ipc云中的门户网站，是一个web服务器，正式版访问地址<a href="https://www.tplinkcloud.com" target="_blank" rel="external">在此</a>。它的业务范围如下:</p>
<ul>
<li>可以让用户在登陆后对接入互联网的设备进行远程监控和操作。</li>
<li>提供给用户设置用户信息的入口。</li>
<li>提供给用户获取最新信息和反馈意见的链接。</li>
</ul>
<p>本系列文档将结合背景，现状和方案，先进理念，设计原则等方面对ipcweb的前端的代码进行详细的介绍。</p>
<p>在介绍Ipcweb时有必要介绍一下ipc云的更新历史。因为每次ipc云进行更新，都将导致ipcweb的需求变化，需求变化会导致设计思路的变化。</p>
<h4 id="Ipc云的更新历史"><a href="#Ipc云的更新历史" class="headerlink" title="Ipc云的更新历史"></a>Ipc云的更新历史</h4><p>Ipcweb运行至今，已经正式发布了四个版本。针对ipc云的更迭，ipcweb也有许多需求变化:</p>
<ol>
<li>1.0.版本，此版本为第一个正式上线的版本。属于从0到1的开拓性里程碑，它界定了ipc云的能力范围，明确了ipc云的核心需求，奠定了ipc云优化迭代的基石。但由于迫切的成品输出的需求，架构设计的相对简单粗暴，业务代码统一维护，从而导致业务区分不清晰，耦合度程度高，不易拓展，也不能针对不同业务进行优化。ipcweb则界定了几乎所有业务范围内的需求。包括用户管理，设备管理，信息咨询等。</li>
<li>2.0.版本，此版本在1.0.的基础上对架构进行优化，将业务区分变得更加合理，同时加入了自动化部署系统以及监控系统，有效的提高了业务的可用性。在我看来，这个版本的ipc云真正做到了人力资源最大化，不同业务模块协同合作，各自开发互不影响。事实上，本司的云平台基础云就是以此架构为基础进行开发与迭代的。ipcweb前端变化不大，主要变化在于后台，将之前的大杂烩服务器拆分出业务不同的服务器，而后续的web则主要作为web服务器，不再提供认证，数据持久化等业务。</li>
<li>3.0.版本。版本更迭的主要起因是公司为整合和统一管理云资源，所以将云分为基础云和业务云。基础云负责物联网设备的基础业务，例如支持设备上线，数据持久化，认证等；业务云主要负责相关的产品的主要业务，例如ipc云主要负责<em>IPCAMERA</em>的业务直播和web。此版本中ipc云更改特别大，因为之前依赖的基础业务全部被替换，其中还包括一些数据一致性，跨域等问题均需要ipc云来做相应的兼容。</li>
<li>3.1.版本。升级的主要原因是，在部分环境下，核心业务不可用，即在chrome42(42及以上)和edge浏览器不再支持已有的直播技术(利用NPAPI插件)。所以更新直播技术是此版本的主要需求。在这个版本中，ipcweb主要需求变化在于前端，针对不同的环境采用不同的直播技术。</li>
</ol>
<h4 id="为什么重构"><a href="#为什么重构" class="headerlink" title="为什么重构"></a>为什么重构</h4><p>在经历了几次迭代之后，本就不怎么健壮的ipcweb前端代码维护起来相当困难，拓展更是不易。这就暴露了前端代码的诸多缺点。</p>
<ol>
<li>纯面向过程编码。通常一个函数方法可以上几百行，这就导致复用性不强，维护起来还相当麻烦。拓展性更不用提。</li>
<li>大量的全局变量。这就导致代码可控性非常低，细微的修改可能导致莫名其妙的问题。</li>
<li>紧耦合的封装导致该封装等于0。一个弹窗类里面包含了主业务代码的全局变量，导致在其他的页面该弹窗类完全无法用。</li>
<li>大量的冗余，废弃的代码。新人接手根本不知道这些代码是不是废弃代码，不敢修改，导致后续的代码只会是一直增加。</li>
<li>前后端代码耦合。Php的代码耦合在前端代码中，针对切换后端解决方案相当不利。</li>
<li>除此之外还有命名不规则，css，html代码混乱等。</li>
</ol>
<p>所以在此背景下，重构显得非常的必要，不仅是为了清理旧代码，换一种清晰干净的编写方式，还为了能够快速应对需求变化，易拓展易维护。所以重构势在必行。</p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ipc-web/">ipc-web</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/front-end/">前端</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/refactor/">重构</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/javascript/">javascript</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>









  
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 Jone Xu
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>